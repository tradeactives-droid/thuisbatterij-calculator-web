<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />

  <!-- FAVICONS -->
  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">

  <title>Eco Metric</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --bg: #f5f7fa;
      --card-bg: #ffffff;
      --text: #1e293b;
      --muted: #64748b;
      --border: #e2e8f0;
      --danger: #dc2626;
      --success: #15803d;
      --highlight: #dbeafe;
      --ui-border-strong: #94a3b8;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #cbe5fc; /* üéØ jouw gekozen kleur */
      color: var(--text);
    }

    .page {
      max-width:1200px;
      margin:0 auto;
      padding:10px 18px 60px; /* üëà minder dode ruimte boven */
    }

    /* =============================== */
    /* CONTENT UITLIJNING (HEADER + UI) */
    /* =============================== */

    .content-container {
      max-width: 900px;   /* exact gelijk aan wizard */
      margin: 0 auto;
    }

    @media (max-width: 960px) {
      .content-container {
        max-width: 100%;
      }
    }

    .title { font-size:2rem; font-weight:700; }
    .subtitle { margin-top:4px; font-size:1rem; color:var(--muted); }

    .app-header { margin-bottom: 10px; }

    .brand{
      display:flex;
      align-items:center;
      gap:14px;
    }

    .brand-logo{
      width:130px;
      height:130px;
      object-fit:contain;
      border-radius:10px;
    }

    /* ===== TOP HEADER (LOGO + USER BAR) ===== */

    .header-inner {
      max-width: 900px;        /* exact gelijk aan content */
      margin: 0 auto;          /* centreert */
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .top-header {
      padding: 4px 0;
      margin-bottom: 4px;
    }


    .user-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.8rem;
      color: #475569;
    }


  /* STEPPER */
  .stepper {
    display:flex;
    gap:10px;
    margin:24px 0;
    flex-wrap:wrap;
  }

  /* üîπ TOEKOMSTIG (default) */
  .step {
    display:flex;
    align-items:center;
    gap:8px;
    padding:8px 16px;
    border-radius:999px;

    background:#e6f1fb;              /* licht grijs-blauw */
    border:1.5px solid var(--ui-border-strong);
    color:#1e3a8a;

    font-size:0.85rem;
    cursor:pointer;

    /* üëá individuele pill-schaduw */
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);

    transition:
      box-shadow 0.2s ease,
      transform 0.15s ease,
      background 0.25s ease;
  }

  /* üîµ ACTIEF */
  .step.active {
    background:#2563eb;
    color:white;
    font-weight:600;

    /* üëá sterker accent */
    border:2px solid #1d4ed8;
    padding:10px 20px;

    box-shadow:0 10px 26px rgba(37,99,235,0.45);
    transform: translateY(-2px) scale(1.03);
  }

  /* üü¶ VOLTOOID */
  .step.completed {
    background:#dbeafe;
    border-color:#93c5fd;
    color:#1d4ed8;

    box-shadow: 0 4px 12px rgba(59,130,246,0.25);  
  }

  /* subtiele hover */
  .step:not(.active):hover {
    background:#cfe4ff;
    transform: translateY(-1px);
  }

  /* badge */
  .badge {
    width:22px;
    height:22px;
    border-radius:999px;
    border:1px solid currentColor;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:0.75rem;
    background:rgba(255,255,255,0.35);
    transition: all 0.2s ease;
  }

  /* ‚úì badge bij voltooide stappen */
  .step.completed .badge {
    background:#2563eb;
    color:white;
    border-color:#2563eb;
    font-weight:700;
  }
    
    .card {
      background:var(--card-bg);
      border-radius:18px;
      padding:26px;

      /* üëá iets sterker los van achtergrond */
      border:1px solid #94a3b8;
      box-shadow:
        0 30px 70px rgba(0,0,0,0.08),
        0 4px 12px rgba(0,0,0,0.04);
    }

    /* =============================== */
    /* LOGIN / SIGNUP LOGO             */
    /* =============================== */

    /* =============================== */
    /* LOGIN / SIGNUP LOGO (RECHTS)    */
    /* =============================== */

    .auth-logo {
      display: flex;
      width: 100%;
      margin-bottom: 12px;
    }

    .auth-logo img {
      width: 90px;
      height: auto;
      margin-left: auto; /* üîë DIT dwingt rechts uitlijning af */
    }    

    /* =============================== */
    /* WIZARD BREEDTE (ALLE STAPPEN)   */
    /* =============================== */

    #wizard-container {
      max-width: 900px;   /* <<< hier stel je de breedte in */
      margin: 0 auto;     /* centreert het witte vlak */
    }

    @media (max-width: 960px) {
      #wizard-container {
        max-width: 100%;
      }
    }

    h2 { margin:0 0 18px 0; font-size:1.4rem; }

    .field { margin-bottom:16px; }
    .field label { display:block; margin-bottom:7px; font-weight:600; }

    .required {
      color: #dc2626;
      margin-left: 4px;
    }

    /* STEP 0 SELECTIE */
    .choice-row {
      display:flex;
      align-items:center;
      gap:10px;
      padding:6px 0;
      font-size:0.95rem;
      cursor:pointer;
    }
    .choice-row input[type="checkbox"]
      width:18px; height:18px;
    }
    .choice-row span { flex:1; }

    input, select {
      width:100%;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid var(--border);
      font-size:0.9rem;
      background:#fafbfc;
    }

    input:focus, select:focus {
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 1px #bfdbfe;
      background:#fff;
    }

    button {
      border:none;
      border-radius:8px;
      padding:10px 18px;
      font-size:0.9rem;
      cursor:pointer;
    }
    .btn-primary { background:var(--primary); color:white; }
    .btn-secondary {
      background: #f8fafc;
      color: #1e293b;

      border: 1.5px solid #0f172a; /* zelfde stijl als pillen */
      border-radius: 999px;

      padding: 8px 14px;
      font-size: 0.85rem;

      cursor: pointer;

      transition:
        background 0.2s ease,
        box-shadow 0.2s ease,
        transform 0.15s ease;
    }
    .btn-secondary:hover {
      background: #e5e7eb;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      transform: translateY(-1px);
    }
    .btn-primary:disabled { opacity:0.5; cursor:not-allowed; }

    .status {
      font-size:0.8rem;
      color:var(--muted);
      margin-top:8px;
    }
    .status.error { color:var(--danger); }
    .status.success { color:var(--success); }

    table {
      width:100%;
      border-collapse:collapse;
      margin-top:14px;
      font-size:0.85rem;
      border:1.5px solid var(--ui-border-strong);
    }
    th,td {
      border:1px solid var(--border);
      padding:8px 10px;
      text-align:right;
    }
    th:first-child, td:first-child { text-align:left; }
    th { background:#f1f5f9; font-weight:600; }
    td.highlight { background:var(--highlight); font-weight:700; }

    /* =============================== */
    /* TABLES ALS CARDS (MATRIX + ENERGIE) */
    /* =============================== */

    .table-card {
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #94a3b8; /* donkerdere rand */
      padding: 12px;
      margin-top: 16px;
    }

    @media (max-width: 900px) {
      .results-summary {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 600px) {
      .results-summary {
        grid-template-columns: 1fr;
      }
    }
    .result-tile {
      border-radius:12px;
      border:1.5px solid var(--ui-border-strong);
      padding:12px 14px;
      background:#f8fafc;
    }
    .result-tile .label {
      font-size:0.8rem;
      color:var(--muted);
      margin-bottom:4px;
    }
    .result-tile .value {
      font-size:1.1rem;
      font-weight:700;
    }

    #chart { margin-top:20px; }

    /* ===== TOOLTIP STYLING ===== */
.info-icon {
  cursor: help;
  margin-left: 6px;
  color: #3b82f6;
  font-weight: bold;
  position: relative;
}

.info-icon:hover::after {
  content: attr(data-tooltip);
  position: absolute;
  top: 20px;
  left: 0;
  background: #1f2937;
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  width: 260px;
  z-index: 999;
  font-size: 13px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

    /* =============================== */
    /* RESULTATEN LAYOUT FIX           */
    /* =============================== */

    .results-container {
      max-width: 760px;   /* <<< dit forceert 3 tiles per rij */
      margin: 0 auto;     /* centreert het blok */
    }

    @media (max-width: 900px) {
      .results-container {
        max-width: 100%;
      }
    }

    /* =============================== */
    /* RESULT TILES GRID               */
    /* =============================== */

    .results-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr); /* 3 per rij op desktop */
      gap: 12px;
    }

    /* =============================== */
    /* SPACING TUSSEN RESULTAAT SECTIES */
    /* =============================== */

    /* Ruimte na de tiles */
    .results-summary {
      margin-bottom: 36px;
    }

    /* Tariefmatrix als sectie */
    .table-card {
      margin-bottom: 40px;
    }

    /* Grafiek-card extra ruimte eronder */
    #chart {
      margin-bottom: 0; /* canvas zelf niet */
    }

    #chart,
    #chart + * {
      margin-bottom: 0;
    }

    /* Grafiek-container (de card rondom de chart) */
    .card:has(#chart) {
      margin-bottom: 44px;
    }

    /* Energie-inzichten tabel */
    .energy-table {
      margin-bottom: 32px;
    }

    /* =============================== */
    /* ADVIESRAPPORT OPMAAK            */
    /* =============================== */

    @import url('https://fonts.googleapis.com/css2?family=Source+Serif+4:wght@400;600&family=Source+Sans+3:wght@400;500;600&display=swap');

    .advice-report-wrapper {
      background: #f3f6f9;
      padding: 32px 0 48px;
    }

    .advice-report {
      background: #ffffff;
      max-width: 760px;
      margin: 0 auto;
      padding: 48px 56px;
      border-radius: 14px;
      border: 1px solid #94a3b8;
      box-shadow: 0 20px 40px rgba(0,0,0,0.08);
    }

    .report-title {
      font-family: 'Source Serif 4', serif;
      font-size: 32px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #1f2933;
    }

    .report-subtitle {
      font-family: 'Source Sans 3', sans-serif;
      font-size: 15px;
      color: #6b7280;
      margin-bottom: 32px;
    }

    .report-content h3 {
      font-family: 'Source Serif 4', serif;
      font-size: 21px;
      margin-top: 36px;
      margin-bottom: 12px;
    }

    .report-content p {
      font-family: 'Source Sans 3', sans-serif;
      font-size: 16px;
      line-height: 1.7;
      margin-bottom: 16px;
    }

    /* =============================== */
    /* BIJLAGEN ‚Äî VISUELE SCHEIDING    */
    /* (CSS-only, inhoud blijft exact)*/
    /* =============================== */

    #advice-rendered {
      white-space: pre-wrap;
    }

    /* ===== ADVIES TITELS + ALINEA‚ÄôS (HTML rendering) ===== */

    #advice-rendered {
      white-space: normal;   /* belangrijk: want we renderen nu HTML */
    }

    .advice-title {
      font-family: 'Source Serif 4', serif;
      font-size: 22px;
      font-weight: 700;
      margin-top: 26px;
      margin-bottom: 14px;
      color: #111827;
    }

    .advice-section-gap {
      height: 24px;   /* meer witruimte tussen secties */
    }

    .advice-paragraph {
      font-family: 'Source Sans 3', sans-serif;
      font-size: 16px;
      line-height: 1.75;
      margin-bottom: 14px;
      color: #1f2937;
    }
    
    /* Visuele scheiding v√≥√≥r Bijlage A */
    #advice-rendered::after {
      content: "";
    }

    /* Marker voor begin bijlagen */
    #advice-rendered {
      position: relative;
    }

    /* Subtiele scheidingslijn v√≥√≥r bijlagen */
    #advice-rendered {
      background-image: linear-gradient(
        to bottom,
        transparent 0%,
        transparent 70%,
        #e5e7eb 70%,
        transparent 72%
      );
      background-repeat: no-repeat;
      background-size: 100% 1px;
    }

    /* Extra ademruimte bij bijlagen */
    #advice-rendered {
      padding-bottom: 8px;
    }

    /* Zachte achtergrond voor onderste deel (bijlagen-zone) */
    .advice-report {
      background:
        linear-gradient(
          to bottom,
          #ffffff 0%,
          #ffffff 75%,
          #f8fafc 100%
        );
    }    
    
    .advisor-notes {
      max-width: 760px;
      margin: 28px auto 0;
    }

    .advisor-notes h3 {
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .advisor-notes textarea {
      width: 100%;
      min-height: 120px;
      padding: 14px 16px;
      font-size: 15px;
      font-family: 'Source Sans 3', sans-serif;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      background: #f9fafb;
    }
    
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
<div class="page">

<div id="login-container" style="max-width:420px; margin:80px auto;">
  <div class="card">
    
    <div class="auth-logo">
      <img src="/logo.png" alt="Eco Metric logo">
    </div>
    
    <h2>Inloggen</h2>

    <div class="field">
      <label>E-mailadres</label>
      <input type="email" id="login-email" required>
    </div>

    <div class="field">
      <label>Wachtwoord</label>
      <input type="password" id="login-password" required>
    </div>

    <button class="btn-primary" id="btn-login" style="width:100%;">
      Inloggen
    </button>

    <button
      class="btn-secondary"
      id="go-to-signup"
      style="width:100%; margin-top:12px;"
    >
      Account aanmaken
    </button>

    <div id="login-status" class="status" style="margin-top:10px;"></div>

  </div>
</div>

  <div id="signup-container" style="max-width:520px; margin:80px auto; display:none;">
    <div class="card">

      <div class="auth-logo">
        <img src="/logo.png" alt="Eco Metric logo">
      </div>
      
      <h2>Account aanmaken</h2>

      <div class="field">
        <label>Voornaam<span class="required">*</span></label>
        <input type="text" id="signup-firstname" required>
      </div>

      <div class="field">
        <label>Achternaam<span class="required">*</span></label>
        <input type="text" id="signup-lastname" required>
      </div>

      <div class="field">
        <label>Bedrijfsnaam<span class="required">*</span></label>
        <input type="text" id="signup-company" required>
      </div>

      <div class="field">
        <label>E-mailadres<span class="required">*</span></label>
        <input type="email" id="signup-email" required>
      </div>

      <div class="field">
        <label>Telefoonnummer<span class="required">*</span></label>
        <input type="tel" id="signup-phone" required>
      </div>

      <div class="field">
        <label>Wachtwoord<span class="required">*</span></label>
        <input type="password" id="signup-password" required>
      </div>

      <div class="field">
        <label>Wachtwoord herhalen<span class="required">*</span></label>
        <input type="password" id="signup-password-confirm" required>
      </div>

      <button class="btn-primary" id="btn-signup-submit" style="width:100%;">
        Account aanmaken
      </button>

      <div id="signup-status" class="status" style="margin-top:10px;"></div>

      <hr style="margin:24px 0; border:none; border-top:1px solid #e2e8f0;">

      <button class="btn-secondary" id="back-to-login" style="width:100%;">
        Terug naar inloggen
      </button>
    </div>
  </div>

<div id="app-view" style="display:none;">

  <!-- ===== HEADER OVER VOLLE BREEDTE ===== -->
  <div class="top-header header-full">
    <div class="header-inner">
      <div class="brand">
        <img src="/logo.png" alt="Eco Metric logo" class="brand-logo">
      </div>

      <div class="user-actions">
        <span id="user-email"></span>
        <button id="btn-logout" class="btn-secondary">Uitloggen</button>
      </div>
    </div>
  </div>

  <!-- ===== GEcentreerde CONTENT ===== -->
  <div class="content-container">

    <div class="stepper">
      <div class="step active" id="step-pill-0"><div class="badge">0</div> Start</div>
      <div class="step" id="step-pill-1"><div class="badge">1</div> Profiel & Tarief</div>
      <div class="step" id="step-pill-2"><div class="badge">2</div> Batterij</div>
      <div class="step" id="step-pill-3"><div class="badge">3</div> Tarieven</div>
      <div class="step" id="step-pill-4"><div class="badge">4</div> Contractkosten</div>
      <div class="step" id="step-pill-5"><div class="badge">5</div> Resultaat</div>
      <div class="step" id="step-pill-6"><div class="badge">6</div> Advies</div>
    </div>

    <div class="card" id="wizard-container">

  <!-- ======================= -->
<!--    STEP 0               -->
<!-- ======================= -->
<div id="step-0">
  <h2>Start nauwkeurige thuisbatterij-analyse</h2>

  <p style="margin-bottom:20px; color:#475569; line-height:1.5;">
    Eco Metric berekent de financi√´le en energetische impact van een thuisbatterij
    op basis van uw <strong>jaarverbruik, jaaropwek</strong> en een realistisch verbruiksprofiel.
  </p>

  <button class="btn-primary" id="to-step-0-next" style="font-size:1rem; padding:14px 24px;">
    Start berekening
  </button>
</div>

<!-- ======================= -->
<!--    STEP 1               -->
<!-- ======================= -->
<div id="step-1" style="display:none;">
  <h2>Stap 1 ¬∑ Profiel & tarief</h2>

  <div class="field">
    <label>Land</label>
    <select id="country">
      <option value="NL">Nederland</option>
      <option value="BE">Belgi√´</option>
    </select>
  </div>

  <div class="field">
    <label>Huidig tarief</label>
    <select id="tariff-type">
      <option value="enkel">Enkel</option>
      <option value="dag_nacht">Dag/Nacht</option>
      <option value="dynamisch">Dynamisch</option>
    </select>
  </div>

  <div class="field">
    <label>Jaarverbruik (kWh)<span class="required">*</span></label>
    <input id="annual-load" type="number" min="0" step="1" placeholder="bijv. 3500">
  </div>

  <div class="field">
    <label>Jaaropwek (kWh)<span class="required">*</span></label>
    <input id="annual-pv" type="number" min="0" step="1" placeholder="bijv. 3200">
  </div>

  <div class="field">
    <label>Woning/huishoudprofiel<span class="required">*</span></label>
    <select id="household-profile">
      <option value="" selected>Kies een profiel</option>
      <option value="alleenstaand_werkend">Alleenstaand (werkend)</option>
      <option value="samenwonend_werkend">Samenwonend (twee personen)</option>
      <option value="gezin_kinderen">Gezin met kinderen</option>
      <option value="thuiswerker">Thuiswerker</option>
    </select>
  </div>

  <!-- EXTRA ENERGIEVERBRUIKERS -->
  <div class="field">
    <label>
      Warmtepomp
      <span class="info-icon"
            data-tooltip="Warmtepomp be√Ønvloedt vooral het profiel (meer verbruik in winter + ochtend/avond).">
        ‚Ñπ
      </span>
    </label>
    <select id="has-heatpump">
      <option value="unknown" selected>Kies een optie</option>
      <option value="no">Nee</option>
      <option value="yes">Ja</option>
    </select>
  </div>

  <div class="field">
    <label>
      Elektrische auto (thuis laden)
      <span class="info-icon"
            data-tooltip="EV-laden be√Ønvloedt vooral het profiel (meer verbruik in avond/nacht).">
        ‚Ñπ
      </span>
    </label>
    <select id="has-ev">
      <option value="unknown" selected>Kies een optie</option>
      <option value="no">Nee</option>
      <option value="yes">Ja</option>
    </select>
  </div>

  <div id="profile-status" class="status">Vul de verplichte velden in om door te gaan.</div>

  <br>
  <button class="btn-secondary" id="to-step-2">Volgende</button>
</div>

<!-- ======================= -->
<!--    STEP 2               -->
<!-- ======================= -->
<div id="step-2" style="display:none;">
  <h2>Stap 2 ¬∑ Batterij</h2>

  <!-- OPSLAGCAPACITEIT -->
  <div class="field">
    <label>
      Opslagcapaciteit | E (kWh)
      <span class="info-icon"
            data-tooltip="De totale hoeveelheid energie die de batterij kan opslaan. 1 kWh = ongeveer 1 uur lang 1000 watt. Een hogere capaciteit betekent meer opslag voor later gebruik.">
        ‚Ñπ
      </span>
    </label>
    <input id="E" type="number" min="0" step="0.1">
  </div>

  <!-- VERMOGEN -->
  <div class="field">
    <label>
      Laad/ontlaadvermogen | P (kW)
      <span class="info-icon"
            data-tooltip="Het maximale vermogen waarmee de batterij kan laden of ontladen. Een hoger vermogen betekent sneller reageren. Voor Belgi√´ is dit belangrijk voor peak-shaving.">
        ‚Ñπ
      </span>
    </label>
    <input id="P" type="number" min="0" step="0.1">
  </div>

  <!-- DOD -->
  <div class="field">
    <label>
      Diepte van Ontlading | DoD (%)
      <span class="info-icon"
            data-tooltip="Het percentage van de batterijcapaciteit dat je veilig kunt gebruiken. Bij 90% DoD kun je 90% van de totale capaciteit benutten.">
        ‚Ñπ
      </span>
    </label>
    <input id="DoD" type="number" min="0" max="100">
  </div>

  <!-- ROUND TRIP EFFICIENCY -->
  <div class="field">
    <label>
      Round-Trip Effici√´ntie | Œ∑_rt (%)
      <span class="info-icon"
            data-tooltip="Als Œ∑_rt niet bekend is, kan je dit op 'niet bekend' zetten. Dan wordt effici√´ntieverlies niet meegenomen in de berekening.">
        ‚Ñπ
      </span>
    </label>

    <select id="eta-known" style="margin-bottom:8px;">
      <option value="unknown" selected>Niet bekend (niet meenemen)</option>
      <option value="known">Bekend (invullen)</option>
    </select>

    <div id="eta-rt-wrap" style="display:none;">
      <input id="eta_rt" type="number" min="0" max="100" placeholder="bijv. 90">
    </div>

  </div>

  <!-- CAPACITEITSTARIEF ‚Äî WORDT BIJ NL AUTOMATISCH VERBORGEN VIA updateCountryUI() -->
  <div class="field">
    <label>
      Capaciteitstarief (‚Ç¨/kW/jaar)
      <span class="info-icon"
            data-tooltip="Alleen Belgi√´ (Fluvius). Kosten per kW maandpiek. Een batterij kan pieken verlagen en zo besparen op dit tarief.">
        ‚Ñπ
      </span>
    </label>
    <input id="capacity-tariff" type="number" min="0" step="0.1" value="0">
  </div>

  <!-- INVESTERING -->
  <div class="field">
    <label>
      Investering Batterij (‚Ç¨)
      <span class="info-icon"
            data-tooltip="De totale aankoopprijs inclusief installatie en omvormer. Dit wordt gebruikt om de terugverdientijd te berekenen.">
        ‚Ñπ
      </span>
    </label>
    <input id="battery-cost" type="number" min="0" step="1">
  </div>

  <!-- LEVENSDUUR BATTERIJ -->
  <div class="field">
    <label>
      Levensduur batterij (jaar)
      <span class="info-icon"
          data-tooltip="De periode waarover de batterij economisch wordt beoordeeld. Dit be√Ønvloedt de totale besparing, ROI en terugverdientijd.">
        ‚Ñπ
      </span>
    </label>
    <select id="battery-lifetime">
      <option value="10">10 jaar</option>
      <option value="15" selected>15 jaar</option>
      <option value="20">20 jaar</option>
      <option value="25">25 jaar</option>
    </select>
  </div>
  
  <!-- DEGRADATIE -->
  <div class="field">
    <label>
      Degradatie per jaar (%)
      <span class="info-icon"
        data-tooltip="Als degradatie niet bekend is, zet op 'niet bekend'. Dan wordt degradatie niet meegenomen in ROI.">
        ‚Ñπ
      </span>
    </label>

    <select id="degradation-known" style="margin-bottom:8px;">
      <option value="unknown" selected>Niet bekend (niet meenemen)</option>
      <option value="known">Bekend (invullen)</option>
    </select>

    <div id="battery-degradation-wrap" style="display:none;">
      <input id="battery-degradation" type="number" min="0" max="10" step="0.1" placeholder="bijv. 2">
    </div>

    </div> <!-- üëà SLUIT .field (degradatie) -->

  <button class="btn-secondary" id="back-to-1">Vorige</button>
  <button class="btn-primary" id="to-step-3">Volgende</button>
  </div>  

<!-- ======================= -->
<!--    STEP 3               -->
<!-- ======================= -->
<div id="step-3" style="display:none;">
  <h2>Stap 3 ¬∑ Tarieven</h2>

  <h3>Enkel tarief</h3>
  <div class="field">
    <label>Importprijs (‚Ç¨/kWh)</label>
    <input id="p_enkel_imp" type="number" step="0.01">
  </div>
  <div class="field">
    <label>Exportprijs (‚Ç¨/kWh)</label>
    <input id="p_enkel_exp" type="number" step="0.01">
  </div>

  <h3>Dag/Nacht tarief</h3>
  <div class="field">
    <label>Dagprijs (‚Ç¨/kWh)</label>
    <input id="p_dag" type="number" step="0.01">
  </div>
  <div class="field">
    <label>Nachtprijs (‚Ç¨/kWh)</label>
    <input id="p_nacht" type="number" step="0.01">
  </div>
  <div class="field">
    <label>Exportprijs (‚Ç¨/kWh)</label>
    <input id="p_exp_dn" type="number" step="0.01">
  </div>

  <h3>Dynamisch tarief</h3>
  <div class="field">
    <label>Exportprijs (‚Ç¨/kWh)</label>
    <input id="p_export_dyn" type="number" step="0.01">
  </div>

  <div id="compute-status" class="status"></div>

  <div id="dyn-fallback-note-historic" class="status" style="display:none;">
    Dynamische prijzen werden gesimuleerd op basis van historische marktdata (APX-profiel).
  </div>

  <button class="btn-secondary" id="back-to-2">Vorige</button>
  <button class="btn-primary" id="to-step-4">Volgende</button>
</div>

  <!-- ======================= -->
  <!--    STEP 4 ¬∑ CONTRACTKOSTEN -->
  <!-- ======================= -->
<div id="step-4" style="display:none;">
  <h2>Stap 4 ¬∑ Contractkosten</h2>

  <h3>Vaste contractkosten</h3>

  <div class="field">
    <label>
      Vastrecht (‚Ç¨/jaar)
      <span class="info-icon"
            data-tooltip="Vaste jaarlijkse kosten van uw energieleverancier.">
        ‚Ñπ
      </span>
    </label>
    <input id="fixed-cost" type="number" min="0" step="0.01" value="200">
  </div>

  <div class="field">
    <label>Terugleverkosten per maand (‚Ç¨/maand)</label>
    <input id="tlv_monthly_fee" type="number" step="0.01" value="0">
  </div>

  <button class="btn-secondary" id="back-to-3">Vorige</button>
  <button class="btn-primary" id="btn-compute">Berekenen</button>
  
  <div id="compute-status" class="status" style="margin-top:10px;"></div>
</div>

<!-- ======================= -->
<!--    STEP 5               -->
<!-- ======================= -->
<div id="step-5" style="display:none;">
  <h2>Stap 5 ¬∑ Resultaten</h2>

  <div class="results-container">

    <div class="results-summary">
  <div class="result-tile">
    <div class="label">A1. Huidige situatie</div>
    <div class="value" id="res-A1">‚Äì</div>
  </div>
  <div class="result-tile">
  <div class="label">
    B1. Geen Saldering | Geen Batterij<br>
    <small id="res-B1-tariff-label" style="color:#64748b;"></small>
  </div>
  <div class="value" id="res-B1">‚Äì</div>
</div>

<div class="result-tile">
  <div class="label">
    C1. Geen Saldering | Met Batterij<br>
    <small id="res-C1-tariff-label" style="color:#64748b;"></small>
  </div>
  <div class="value" id="res-C1">‚Äì</div>
</div>

  <!-- NIEUW: BESPARING / PAYBACK / ROI -->
  <div class="result-tile">
    <div class="label">
      Besparing per jaar<br>
      <small style="color:#64748b;">
        verschil tussen toekomst zonder en met batterij
      </small>
    </div>
    <div class="value" id="res-savings">‚Äì</div>
  </div>
  <div class="result-tile">
    <div class="label">
      Terugverdientijd<br>
      <small style="color:#64748b">incl. batterijdegradatie</small>
    </div>
    <div class="value" id="res-payback">‚Äì</div>
  </div>
  <div class="result-tile">
    <div class="label">
      ROI (%)
      <span class="info-icon"
            data-tooltip="ROI = netto rendement over de volledige levensduur van de batterij, inclusief jaarlijkse degradatie.">
        ‚Ñπ
      </span>
      <br>
      <small style="color:#64748b">over volledige levensduur</small>
    </div>
    <div class="value" id="res-roi">‚Äì</div>
  </div>
  <div class="result-tile">
  <div class="label">Piek zonder batterij (kW)</div>
  <div class="value" id="res-peak-no">‚Äì</div>
</div>

  

<div class="result-tile">
  <div class="label">Piek met batterij (kW)</div>
  <div class="value" id="res-peak-yes">‚Äì</div>
</div>

<div class="result-tile">
  <div class="label">Besparing capaciteitstarief / jaar</div>
  <div class="value" id="res-peak-saving">‚Äì</div>
</div>
</div>

  <h3>Tariefmatrix (jaarlijkse kosten)</h3>

  <div class="table-card">
    <table class="table-card">
    <tr>
      <th>Scenario</th>
      <th>Enkel</th>
      <th>Dag/Nacht</th>
      <th>Dynamisch</th>
    </tr>
    <tr>
      <td>Huidige situatie</td>
      <td id="A1-enkel">‚Äì</td>
      <td id="A1-dn">‚Äì</td>
      <td id="A1-dyn">‚Äì</td>
    </tr>
    <tr>
      <td>Geen Saldering | Geen Batterij</td>
      <td id="B1-enkel">‚Äì</td>
      <td id="B1-dn">‚Äì</td>
      <td id="B1-dyn">‚Äì</td>
    </tr>
    <tr>
      <td>Geen Saldering | Met Batterij</td>
      <td id="C1-enkel">‚Äì</td>
      <td id="C1-dn">‚Äì</td>
      <td id="C1-dyn">‚Äì</td>
    </tr>
  </table>
  </div>

  <h3>Grafiek ‚Äî Kosten & rendement over levensduur</h3>

  <div class="card" style="margin-top:16px;">
    <canvas id="chart" height="180"></canvas>
  </div>
  
  <h3>Energie-inzichten (kWh)</h3>

  <div class="table-card">
    <table class="table-card energy-table">
    <tr>
      <th></th>
      <th>Enkel</th>
      <th>Dag/Nacht</th>
      <th>Dynamisch</th>
    </tr>
    <tr>
      <td>B1 Import</td>
      <td id="B1-imp-enkel">‚Äì</td>
      <td id="B1-imp-dn">‚Äì</td>
      <td id="B1-imp-dyn">‚Äì</td>
    </tr>
    <tr>
      <td>B1 Export</td>
      <td id="B1-exp-enkel">‚Äì</td>
      <td id="B1-exp-dn">‚Äì</td>
      <td id="B1-exp-dyn">‚Äì</td>
    </tr>
    <tr>
      <td>C1 Import</td>
      <td id="C1-imp-enkel">‚Äì</td>
      <td id="C1-imp-dn">‚Äì</td>
      <td id="C1-imp-dyn">‚Äì</td>
    </tr>
    <tr>
      <td>C1 Export</td>
      <td id="C1-exp-enkel">‚Äì</td>
      <td id="C1-exp-dn">‚Äì</td>
      <td id="C1-exp-dyn">‚Äì</td>
    </tr>
  </table>
  </div>

  <br>
  <button class="btn-primary" id="btn-download-pdf" style="display:none;">
    üìÑ Download PDF
  </button>

  <button class="btn-secondary" id="to-step-6" style="margin-left:8px;">
    Persoonlijk advies bekijken
  </button>

  </div> <!-- results-container -->
  </div>

<!-- ======================= -->
<!--    STEP 6 ¬∑ ADVIES      -->
<!-- ======================= -->
<div id="step-6" style="display:none;">
  <h2>Stap 6 ¬∑ Persoonlijk advies</h2>

  <p class="status" id="advice-status">
    Klik op ‚ÄúGenereer advies‚Äù om een professioneel adviesrapport te maken.
  </p>

  <!-- ===== ADVIESRAPPORT (READ-ONLY WEERGAVE) ===== -->
  <div class="advice-report-wrapper">
    <div class="advice-report">
      <h1 class="report-title">Thuisbatterij Adviesrapport</h1>
      <p class="report-subtitle">
        Besluitondersteunend energieadvies op basis van uw verbruiksdata en batterijconfiguratie
      </p>

      <div id="advice-rendered"></div>

      <div id="advice-results"></div>

      <div id="advice-tariff-matrix-section" class="advice-section" style="display:none;">
      
    </div>

  <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:16px;">
    <button class="btn-secondary" id="back-to-4">Terug naar resultaten</button>
    <button class="btn-primary" id="btn-generate-advice">Genereer advies</button>
  </div>
</div>

</div> <!-- wizard end -->

</div> <!-- content-container -->

</div> <!-- page -->

  <!-- ========================================================= -->
<!-- ===================  PDF HELPER FUNCTIES  ================ -->
<!-- ========================================================= -->
<script>
function pdfDrawTable(doc, startX, startY, rows, colWidths) {
  let y = startY;
  const rowHeight = 18;

  doc.setFont("helvetica", "bold");
  for (let i = 0; i < rows[0].length; i++) {
    const offset = colWidths.slice(0, i).reduce((a,b)=>a+b,0);
    doc.text(String(rows[0][i]), startX + offset + 4, y);
  }
  y += rowHeight;

  doc.setFont("helvetica","normal");

  for (let r = 1; r < rows.length; r++) {
    let x = startX;
    for (let c = 0; c < rows[r].length; c++) {
      doc.text(String(rows[r][c]), x + 4, y);
      x += colWidths[c];
    }
    y += rowHeight;
  }

  const totalWidth = colWidths.reduce((a,b)=>a+b,0);
  const totalHeight = rowHeight * rows.length;
  doc.rect(startX, startY - rowHeight, totalWidth, totalHeight);

  return y + 10;
}

function pdfHeader(doc) {
  doc.setFont("helvetica", "bold");
  doc.setFontSize(22);
  doc.text("Thuisbatterij Adviesrapport", 40, 60);

  doc.setFontSize(11);
  doc.setFont("helvetica","normal");
  doc.text("Gegenereerd op: " + new Date().toLocaleDateString("nl-NL"), 40, 82);
}

function pdfRenderFullAdvice(doc, adviceText) {
  if (!adviceText || adviceText.trim() === "") return;

  doc.setFont("helvetica", "normal");
  doc.setFontSize(11);

  const lines = doc.splitTextToSize(adviceText, 520);

  let y = 120;

  for (let i = 0; i < lines.length; i++) {
    if (y > 780) {
      doc.addPage();
      y = 60;
    }
    doc.text(lines[i], 40, y);
    y += 14;
  }
}  

function pdfIntro(doc) {
  doc.setFont("helvetica","bold");
  doc.setFontSize(16);
  doc.text("1. Inleiding", 40, 120);

  doc.setFont("helvetica","normal");
  doc.setFontSize(12);

  const intro =
    "Dit rapport bevat een volledige financi√´le en energetische analyse van uw woning " +
    "onder drie tariefstructuren (Enkel, Dag/Nacht, Dynamisch) en in drie scenario‚Äôs: " +
    "huidige situatie, toekomst zonder thuisbatterij en toekomst met thuisbatterij.";

  const lines = doc.splitTextToSize(intro, 520);
  doc.text(lines, 40, 145);
}

function pdfTariffMatrix(doc) {
  doc.addPage();
  doc.setFont("helvetica","bold");
  doc.setFontSize(16);
  doc.text("2. Tarievenoverzicht", 40, 60);

  const rows = [
    ["Tarief", "Importprijs", "Exportprijs"],
    [
      "Enkel",
      document.getElementById("p_enkel_imp").value + " ‚Ç¨/kWh",
      document.getElementById("p_enkel_exp").value + " ‚Ç¨/kWh"
    ],
    [
      "Dag/Nacht",
      document.getElementById("p_dag").value + " / " +
      document.getElementById("p_nacht").value + " ‚Ç¨/kWh",
      document.getElementById("p_exp_dn").value + " ‚Ç¨/kWh"
    ],
    [
      "Dynamisch",
      "Gemiddelde prijsmodel",
      document.getElementById("p_export_dyn").value + " ‚Ç¨/kWh"
    ]
  ];

  pdfDrawTable(doc, 40, 100, rows, [160, 180, 180]);
}

function pdfCostMatrix(doc, data) {
  doc.addPage();
  doc.setFont("helvetica","bold");
  doc.setFontSize(16);
  doc.text("3. Kostenmatrix (jaarlijkse kosten)", 40, 60);

  const rows = [
    ["Scenario", "Enkel", "Dag/Nacht", "Dynamisch"],
    ["Huidige situatie",
      fmtEuro(data.A1_per_tariff.enkel),
      fmtEuro(data.A1_per_tariff.dag_nacht),
      fmtEuro(data.A1_per_tariff.dynamisch)
    ],
    ["Toekomst zonder batterij",
      fmtEuro(data.S2_enkel.total_cost),
      fmtEuro(data.S2_dn.total_cost),
      fmtEuro(data.S2_dyn.total_cost)
    ],
    ["Toekomst met batterij",
      fmtEuro(data.S3_enkel.total_cost),
      fmtEuro(data.S3_dn.total_cost),
      fmtEuro(data.S3_dyn.total_cost)
    ]
  ];

  pdfDrawTable(doc, 40, 100, rows, [160, 140, 140, 140]);
}

function pdfEnergyTables(doc, data) {
  doc.addPage();
  doc.setFont("helvetica","bold");
  doc.setFontSize(16);
  doc.text("4. Energie-inzichten (kWh)", 40, 60);

  const imports = [
    ["Scenario", "Enkel", "Dag/Nacht", "Dynamisch"],
    ["B1 Import",
      data.S2_enkel.import.toFixed(1),
      data.S2_dn.import.toFixed(1),
      data.S2_dyn.import.toFixed(1)
    ],
    ["C1 Import",
      data.S3_enkel.import.toFixed(1),
      data.S3_dn.import.toFixed(1),
      data.S3_dyn.import.toFixed(1)
    ]
  ];

  let y = pdfDrawTable(doc, 40, 100, imports, [160, 140, 140, 140]);

  const exports = [
    ["Scenario", "Enkel", "Dag/Nacht", "Dynamisch"],
    ["B1 Export",
      data.S2_enkel.export.toFixed(1),
      data.S2_dn.export.toFixed(1),
      data.S2_dyn.export.toFixed(1)
    ],
    ["C1 Export",
      data.S3_enkel.export.toFixed(1),
      data.S3_dn.export.toFixed(1),
      data.S3_dyn.export.toFixed(1)
    ]
  ];

  pdfDrawTable(doc, 40, y + 20, exports, [160, 140, 140, 140]);
}

function pdfBatteryStats(doc, data) {
  doc.addPage();
  doc.setFont("helvetica","bold");
  doc.setFontSize(16);
  doc.text("5. Batterijprestaties", 40, 60);

  const s3 = data.S3_enkel || {import:0, export:0};

  const E   = parseFloat(document.getElementById("E").value || "0");
  const P   = parseFloat(document.getElementById("P").value || "0");
  const DoD = parseFloat(document.getElementById("DoD").value || "0");
  const eta = parseFloat(document.getElementById("eta_rt").value || "0");

  const rows = [
    ["Parameter", "Waarde"],
    ["Import met batterij (kWh)", s3.import.toFixed(1)],
    ["Export met batterij (kWh)", s3.export.toFixed(1)],
    ["Batterijcapaciteit (kWh)", E || "‚Äì"],
    ["Vermogen (kW)", P || "‚Äì"],
    ["Depth of Discharge (%)", DoD || "‚Äì"],
    ["Round-trip effici√´ntie (%)", eta || "‚Äì"]
  ];

  pdfDrawTable(doc, 40, 100, rows, [260, 260]);
}

function pdfAdviceSection(doc, adviceText) {
  // Geen advies? Dan geen extra pagina.
  if (!adviceText || adviceText.trim() === "") return;

  doc.addPage();
  doc.setFont("helvetica","bold");
  doc.setFontSize(16);
  doc.text("6. Persoonlijk advies", 40, 60);

  doc.setFont("helvetica","normal");
  doc.setFontSize(11);

  // Lange tekst netjes afbreken
  const lines = doc.splitTextToSize(adviceText, 520);
  doc.text(lines, 40, 90);
}

function pdfExport(data) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"a4" });

  pdfHeader(doc);

  // ‚úÖ Adviestekst ophalen: eerst uit textarea, dan uit computedAdvice
  const adviceText = window.computedAdvice || "";

  doc.save("Thuisbatterij-adviesrapport.pdf");
}
</script>

  
<!-- ========================================================= -->
<!-- =============   HOOFDLOGICA / APP     =================== -->
<!-- ========================================================= -->
<script>
const API_BASE = "https://batteryengine-server.onrender.com";
let parsedData = {};
let costChart = null;

function getTariffLabel(code) {
  switch (code) {
    case "enkel":
      return "Enkel tarief";
    case "dag_nacht":
      return "Dag/Nacht tarief";
    case "dynamisch":
      return "Dynamisch tarief";
    default:
      return code;
  }
}

// üîÅ HERRENDER RESULTATEN BIJ TARIEFWISSEL
document.getElementById("tariff-type").addEventListener("change", () => {
  // Alleen her-renderen als er al een berekening is
  if (!window.computedResult) return;

  fillResults(window.computedResult);
  updateCostChart(window.computedResult);
});

function updateCountryUI() {
  const country = document.getElementById("country").value;

  const capacityField = document.getElementById("capacity-tariff").parentElement;

  const tilePeakNo  = document.getElementById("res-peak-no").parentElement;
  const tilePeakYes = document.getElementById("res-peak-yes").parentElement;
  const tilePeakSav = document.getElementById("res-peak-saving").parentElement;

  if (country === "NL") {
    capacityField.style.display = "none";
    tilePeakNo.style.display  = "none";
    tilePeakYes.style.display = "none";
    tilePeakSav.style.display = "none";
  } else {
    capacityField.style.display = "block";
    
    tilePeakNo.style.display  = "block";
    tilePeakYes.style.display = "block";
    tilePeakSav.style.display = "block";
  }
}

document.getElementById("country").addEventListener("change", updateCountryUI);

function applyTariffDefaultsIfEmpty() {
  const defaults = {
    p_enkel_imp: "0.29",
    p_enkel_exp: "0.07",
    p_dag: "0.31",
    p_nacht: "0.26",
    p_exp_dn: "0.07",
    p_export_dyn: "0.07"
  };

  Object.entries(defaults).forEach(([id, value]) => {
    const el = document.getElementById(id);
    if (el && (el.value === "" || el.value === null)) {
      el.value = value;
    }
  });
}

 function wireUnknownToggles() {
  const etaSel  = document.getElementById("eta-known");
  const etaInp  = document.getElementById("eta_rt");
  const etaWrap = document.getElementById("eta-rt-wrap");

  const degSel  = document.getElementById("degradation-known");
  const degInp  = document.getElementById("battery-degradation");
  const degWrap = document.getElementById("battery-degradation-wrap");

  if (etaSel && etaInp && etaWrap) {
    const syncEta = () => {
      const known = etaSel.value === "known";
      etaWrap.style.display = known ? "block" : "none";

      if (!known) {
        etaInp.value = "";
      } else if (etaInp.value === "") {
        etaInp.value = "90";
      }
    };

    etaSel.addEventListener("change", syncEta);
    syncEta();
  }

  if (degSel && degInp && degWrap) {
    const syncDeg = () => {
      const known = degSel.value === "known";
      degWrap.style.display = known ? "block" : "none";

      if (!known) {
        degInp.value = "";
      } else if (degInp.value === "") {
        degInp.value = "2";
      }
    };

    degSel.addEventListener("change", syncDeg);
    syncDeg();
  }
}
  
/* ----------------------------- */
/*       WIZARD STAPPEN          */
/* ----------------------------- */
function activateStep(n) {
  for (let i = 0; i < 7; i++) {
    const pill  = document.getElementById("step-pill-" + i);
    const step  = document.getElementById("step-" + i);
    const badge = pill ? pill.querySelector(".badge") : null;

    if (pill) {
      pill.classList.toggle("active", i === n);
      pill.classList.toggle("completed", i < n);
    }

    // ‚úì in badge bij voltooide stappen
    if (badge) {
      if (i < n) {
        badge.textContent = "‚úì";
      } else {
        badge.textContent = i.toString();
      }
    }

    if (step) {
      step.style.display = (i === n) ? "block" : "none";
    }
  }
}


function fmtEuro(x) {
  const v = Number(x);
  if (!isFinite(v)) return "‚Äì";
  return "‚Ç¨ " + v.toFixed(2).replace(".", ",");
}


/* ----------------------------- */
/*      NAVIGATIE                */
/* ----------------------------- */
document.getElementById("to-step-0-next").addEventListener("click", () => {
  // expliciet start wizard
  activateStep(1);
});

document.getElementById("to-step-2").addEventListener("click", () => {
  const status = document.getElementById("profile-status");

  const annualLoad = parseFloat(document.getElementById("annual-load").value || "0");
  const annualPv   = parseFloat(document.getElementById("annual-pv").value || "0");
  const profile    = document.getElementById("household-profile").value || "";

  if (!isFinite(annualLoad) || annualLoad <= 0) {
    status.textContent = "Vul een geldig jaarverbruik in.";
    status.className = "status error";
    return;
  }
  if (!isFinite(annualPv) || annualPv < 0) {
    status.textContent = "Vul een geldige jaaropwek in.";
    status.className = "status error";
    return;
  }
  if (!profile) {
    status.textContent = "Kies een huishoudenprofiel.";
    status.className = "status error";
    return;
  }

  status.textContent = "Profiel ingesteld ‚úî";
  status.className = "status success";
  activateStep(2);
});
  
document.getElementById("back-to-1").addEventListener("click", () => activateStep(1));
document.getElementById("to-step-3").addEventListener("click", () => {
  activateStep(3);
  applyTariffDefaultsIfEmpty();
});
document.getElementById("back-to-2").addEventListener("click", () => activateStep(2));
document.getElementById("back-to-3")
  ?.addEventListener("click", () => activateStep(3));
document.getElementById("to-step-4")
  ?.addEventListener("click", () => activateStep(4));

document.getElementById("back-to-4").addEventListener("click", () => activateStep(4));

document.getElementById("to-step-6")?.addEventListener("click", () => {
  if (!window.computedResult) {
    alert("Voer eerst een berekening uit.");
    return;
  }
  activateStep(6);
});

/* ----------------------------- */
/*      COMPUTE                 */
/* ----------------------------- */
document.getElementById("btn-compute").addEventListener("click", async () => {
  const btn = document.getElementById("btn-compute");
  const status = document.getElementById("compute-status");

  // UI feedback: start berekening
  btn.disabled = true;
  btn.textContent = "‚è≥ Bezig met berekenen...";
  status.textContent = "Berekening wordt uitgevoerd, dit kan enkele seconden duren‚Ä¶";
  status.className = "status";

  // ===============================
  // Batterij-investering (veilig)
  // ===============================
  const batteryCostRaw = document.getElementById("battery-cost").value || "";
  const cleanedBatteryCost = batteryCostRaw
    .replace("‚Ç¨", "")
    .replace(",", ".")
    .replace(/\s+/g, "");

  const batteryCost = parseFloat(cleanedBatteryCost);

  if (!cleanedBatteryCost || isNaN(batteryCost) || batteryCost <= 0) {
    status.textContent = "Voer een geldige batterij-investering in.";
    status.className = "status error";

    // UI herstellen
    btn.disabled = false;
    btn.textContent = "Berekenen";

    return;
  }

  // ===============================
  // üîß Omvormerkosten
  // UI = ‚Ç¨/kW per maand
  // ===============================
  
  // üîß Omvormerkosten (veilig ‚Äî voorkomt 422)
  const inverterPower =
    parseFloat(document.getElementById("P").value || "0");

  const inverterCostPerKwMonth =
    parseFloat(document.getElementById("tlv_per_kw_inverter").value || "0");

  // ===============================
  // REQUEST BODY
  // ===============================
  const etaKnown = document.getElementById("eta-known")?.value === "known";
  const degKnown = document.getElementById("degradation-known")?.value === "known";

  const etaRtPercent = parseFloat(document.getElementById("eta_rt").value || "");
  const degPercent   = parseFloat(document.getElementById("battery-degradation").value || "");

  // === Terugleverkosten (vereenvoudigd) ===
  const tlv_monthly_fee =
    parseFloat(document.getElementById("tlv_monthly_fee")?.value || "0");

  const tlv_per_kwh = 0;
  const tlv_free_kwh = 0;
  
  const body = {
    // NIEUWE INPUT (profiel-based)
    annual_load_kwh: parseFloat(document.getElementById("annual-load").value || "0"),
    annual_pv_kwh: parseFloat(document.getElementById("annual-pv").value || "0"),
    household_profile: document.getElementById("household-profile").value,

    has_heatpump: document.getElementById("has-heatpump")?.value === "yes",
    has_ev: document.getElementById("has-ev")?.value === "yes",

    // Dynamisch model ‚Äî vaste defaults (UI verborgen)
    dyn_avg_import_price: 0.28,
    dyn_spread: 0.10,
    dyn_cheap_hours_per_day: 8,

    // Tarieven
    p_enkel_imp: parseFloat(document.getElementById("p_enkel_imp").value || "0.29"),
    p_enkel_exp: parseFloat(document.getElementById("p_enkel_exp").value || "0.07"),

    p_dag: parseFloat(document.getElementById("p_dag").value || "0.31"),
    p_nacht: parseFloat(document.getElementById("p_nacht").value || "0.26"),
    p_exp_dn: parseFloat(document.getElementById("p_exp_dn").value || "0.07"),

    p_export_dyn: parseFloat(document.getElementById("p_export_dyn").value || "0.07"),

    // Terugleverkosten (vereenvoudigd)
    feedin_monthly_cost: tlv_monthly_fee,
    feedin_cost_per_kwh: tlv_per_kwh,
    feedin_free_kwh: tlv_free_kwh,
    feedin_price_after_free: tlv_per_kwh,

    // Omvormer
    inverter_power_kw: inverterPower,
    inverter_cost_per_kw_month: inverterPower > 0 ? inverterCostPerKwMonth : 0,
    inverter_cost_per_kw: inverterPower > 0 ? inverterCostPerKwMonth * 12 : 0,

    // Batterij
    E: parseFloat(document.getElementById("E").value || "0"),
    P: parseFloat(document.getElementById("P").value || "0"),
    DoD: parseFloat(document.getElementById("DoD").value || "0") / 100,

    // RTE / Degradatie: NULL als onbekend
    eta_rt: etaKnown && isFinite(etaRtPercent) ? (etaRtPercent / 100) : null,
    battery_degradation: degKnown && isFinite(degPercent) ? (degPercent / 100) : null,

    // Vastrecht (‚Ç¨/jaar)
    vastrecht_year: parseFloat(document.getElementById("fixed-cost").value || "0"),

    // Investering & levensduur
    battery_cost: batteryCost,
    battery_lifetime_years: parseInt(document.getElementById("battery-lifetime").value || "15"),

    // Capaciteitstarief (BE)
    capacity_tariff_kw: parseFloat(document.getElementById("capacity-tariff").value || "0"),

    // Context
    country: document.getElementById("country").value || "NL",
    current_tariff: document.getElementById("tariff-type").value || "enkel"
  };

  try {
    const res = await fetch(API_BASE + "/compute_v3_profile", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    const data = await res.json();

if (
  !data ||
  !data.A1_per_tariff ||
  !data.B1 ||
  !data.C1 ||
  !data.B1_monthly ||
  !data.C1_monthly ||
  !data.roi_per_tariff
) {
  console.error("Backend response:", data);
  status.textContent = "Ongeldig antwoord van de server.";
  status.className = "status error";

  // UI herstellen
  btn.disabled = false;
  btn.textContent = "Berekenen";

  return;
}

    window.computedResult = data;

    status.textContent = "Berekening afgerond.";
    status.className = "status success";
    
    activateStep(5);
    fillResults(data);
    updateCountryUI(); 
    updateCostChart(data);

    btn.disabled = false;
    btn.textContent = "Berekenen";

  } catch (err) {
    status.textContent = "Fout: " + err.message;
    status.className = "status error";

    // UI herstellen
    btn.disabled = false;
    btn.textContent = "Berekenen";
  }
});

  function fillResults(data) {
    // üîë huidig gekozen tarief
    const tariff = document.getElementById("tariff-type").value || "enkel";

    const A1 = data.A1_per_tariff[tariff]?.total_cost_eur;
    const B1 = data.B1[tariff]?.total_cost_eur;
    const C1 = data.C1[tariff]?.total_cost_eur;

    // === Tiles ===
    document.getElementById("res-A1").textContent = fmtEuro(A1);
    document.getElementById("res-B1").textContent = fmtEuro(B1);
    document.getElementById("res-C1").textContent = fmtEuro(C1);

    // === Besparing ===
    document.getElementById("res-savings").textContent =
      isFinite(B1) && isFinite(C1) ? fmtEuro(B1 - C1) : "‚Äì";

    // === ROI & Payback (PER TARIEF!) ===
    const roi = data.roi_per_tariff[tariff];

    const paybackEl = document.getElementById("res-payback");
    const roiEl = document.getElementById("res-roi");

    // Default styling resetten
    paybackEl.style.color = "";
    roiEl.style.color = "";

    // ‚ùó Geen rendabele businesscase
    if (!roi || roi.yearly_saving_eur <= 0 || roi.payback_years === null) {
      paybackEl.textContent = "Niet rendabel";
      roiEl.textContent = "0.0 %";

      paybackEl.style.color = "#dc2626"; // rood
      roiEl.style.color = "#dc2626";     // rood
    } else {
      paybackEl.textContent = roi.payback_years.toFixed(1) + " jaar";
      roiEl.textContent = roi.roi_percent.toFixed(1) + " %";
    }
    
    // =========================
    // TARIEFMATRIX ‚Äî JAARLIJKSE KOSTEN
    // =========================

    // A1 ‚Äî huidige situatie (met saldering)
    document.getElementById("A1-enkel").textContent =
      fmtEuro(data.A1_per_tariff?.enkel?.total_cost_eur);

    document.getElementById("A1-dn").textContent =
      fmtEuro(data.A1_per_tariff?.dag_nacht?.total_cost_eur);

    document.getElementById("A1-dyn").textContent =
      fmtEuro(data.A1_per_tariff?.dynamisch?.total_cost_eur);


    // B1 ‚Äî toekomst zonder batterij
    document.getElementById("B1-enkel").textContent =
      fmtEuro(data.B1?.enkel?.total_cost_eur);

    document.getElementById("B1-dn").textContent =
      fmtEuro(data.B1?.dag_nacht?.total_cost_eur);

    document.getElementById("B1-dyn").textContent =
      fmtEuro(data.B1?.dynamisch?.total_cost_eur);


    // C1 ‚Äî toekomst met batterij
    document.getElementById("C1-enkel").textContent =
      fmtEuro(data.C1?.enkel?.total_cost_eur);

    document.getElementById("C1-dn").textContent =
      fmtEuro(data.C1?.dag_nacht?.total_cost_eur);

    document.getElementById("C1-dyn").textContent =
      fmtEuro(data.C1?.dynamisch?.total_cost_eur);

    // =========================
    // ENERGIE-INZICHTEN (kWh)
    // =========================

    const fmtKwh = (v) =>
      (isFinite(v) ? v.toFixed(0) + " kWh" : "‚Äì");

    // --- B1 ---
    document.getElementById("B1-imp-enkel").textContent =
      fmtKwh(data.B1?.enkel?.import_kwh);

    document.getElementById("B1-exp-enkel").textContent =
      fmtKwh(data.B1?.enkel?.export_kwh);

    document.getElementById("B1-imp-dn").textContent =
      fmtKwh(data.B1?.dag_nacht?.import_kwh);

    document.getElementById("B1-exp-dn").textContent =
      fmtKwh(data.B1?.dag_nacht?.export_kwh);

    document.getElementById("B1-imp-dyn").textContent =
      fmtKwh(data.B1?.dynamisch?.import_kwh);

    document.getElementById("B1-exp-dyn").textContent =
      fmtKwh(data.B1?.dynamisch?.export_kwh);

    // --- C1 ---
    document.getElementById("C1-imp-enkel").textContent =
      fmtKwh(data.C1?.enkel?.import_kwh);

    document.getElementById("C1-exp-enkel").textContent =
      fmtKwh(data.C1?.enkel?.export_kwh);

    document.getElementById("C1-imp-dn").textContent =
      fmtKwh(data.C1?.dag_nacht?.import_kwh);

    document.getElementById("C1-exp-dn").textContent =
      fmtKwh(data.C1?.dag_nacht?.export_kwh);

    document.getElementById("C1-imp-dyn").textContent =
      fmtKwh(data.C1?.dynamisch?.import_kwh);

    document.getElementById("C1-exp-dyn").textContent =
      fmtKwh(data.C1?.dynamisch?.export_kwh);
    
  }

  // ‚ö†Ô∏è UI-ONLY helper
  // Deze functie mag uitsluitend gebruikt worden voor visualisaties of UI-inzichten.
  // Resultaten uit deze functie mogen NIET worden gebruikt voor AI-advies of backend-context.
  
/* ----------------------------- */
/*   ADVICE CONTEXT (FACTS)     */
/* ----------------------------- */
function buildAdviceContext(data) {
  const country = document.getElementById("country").value || "NL";

  return {
    country,
    current_tariff: document.getElementById("tariff-type").value || "enkel",

    calculation_method: data.calculation_method || {},

    profile_inputs: {
      annual_load_kwh: parseFloat(document.getElementById("annual-load").value || "0"),
      annual_pv_kwh: parseFloat(document.getElementById("annual-pv").value || "0"),
      household_profile: document.getElementById("household-profile").value || ""
    },
    
    energy_profile: data.energy_profile || {},

    battery: {
      E: parseFloat(document.getElementById("E").value || "0"),
      P: parseFloat(document.getElementById("P").value || "0")
    },

    battery_assessment: data.battery_assessment || null,

    extra_consumers: {
      heat_pump: document.getElementById("has-heatpump")?.value === "yes",
      ev: document.getElementById("has-ev")?.value === "yes"
    },

    tariff_matrix: data.tariff_matrix || data.A1_per_tariff || {},

    roi_per_tariff: data.roi_per_tariff || {}
  };
}
  
function buildAdviceText(data) {
  // Frontend levert GEEN eigen tekst meer
  // Backend genereert het volledige advies
  return "";
}

function escapeHtml(str) {
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;");
}

function isTitleLine(line) {
  // Sectietitels: "1. Managementsamenvatting" etc.
  if (/^\d+\.\s+/.test(line)) return true;

  // Bijlagen: "Bijlage A ‚Äî ..." etc.
  if (/^Bijlage\s+[A-D]\s+‚Äî\s+/.test(line)) return true;

  return false;
}

function renderAdviceToHtml(adviceText) {
  const el = document.getElementById("advice-rendered");
  if (!el) return;

  if (!adviceText || adviceText.trim() === "") {
    el.innerHTML = "";
    return;
  }

  // Split per newline en trim rechterkant
  const lines = adviceText.split("\n").map(l => l.replace(/\s+$/, ""));

  let html = "";
  let buffer = [];

  function flushParagraph() {
    const text = buffer.join(" ").trim();
    buffer = [];
    if (!text) return;
    html += `<div class="advice-paragraph">${escapeHtml(text)}</div>`;
  }

  for (const rawLine of lines) {
    const line = rawLine.trim();

    // Lege regel = alinea afsluiten
    if (line === "") {
      flushParagraph();
      continue;
    }

    // Titelregel
    if (isTitleLine(line)) {
      flushParagraph();

      // ‚úÖ extra witruimte tussen einde vorige sectie en nieuwe titel
      // (niet v√≥√≥r de allereerste titel)
      if (html !== "") {
        html += `<div class="advice-section-gap"></div>`;
      }

  html += `<div class="advice-title">${escapeHtml(line)}</div>`;
  continue;
}

    // Normale tekstregel -> toevoegen aan alinea buffer
    buffer.push(line);
  }

  flushParagraph();

  el.innerHTML = html;
}

  function injectResultsIntoAdvice() {
    const target = document.getElementById("advice-results");
    if (!target) return;
    if (!window.computedResult) return;

    // Leegmaken zodat opnieuw genereren netjes blijft
    target.innerHTML = "";

    // Helper om bestaande blokken exact te kopi√´ren
    const clone = (selector) => {
      const el = document.querySelector(selector);
      return el ? el.cloneNode(true) : null;
    };

    // 1Ô∏è‚É£ Resultaat-tiles
    const tiles = clone(".results-summary");
    if (tiles) {
      target.appendChild(tiles);
    }

    // 2Ô∏è‚É£ Tariefmatrix (alleen de tabel, opnieuw verpakt)
    const tariffTable = clone(".table-card table");
    if (tariffTable) {
      const wrap = document.createElement("div");
      wrap.className = "table-card";
      wrap.appendChild(tariffTable);
      target.appendChild(wrap);
    }

    // 3Ô∏è‚É£ Grafiek (canvas + card)
    const chartCard = document.querySelector("#chart")?.closest(".card");
    if (chartCard) {
      const chartClone = chartCard.cloneNode(true);
      target.appendChild(chartClone);
    }

    // 4Ô∏è‚É£ Energie-inzichten
    const energyTable = clone(".energy-table");
    if (energyTable) {
      const wrap = document.createElement("div");
      wrap.className = "table-card";
      wrap.appendChild(energyTable);
      target.appendChild(wrap);
    }
  }
  
document.getElementById("btn-generate-advice").addEventListener("click", async () => {
  const statusEl = document.getElementById("advice-status");
  const textEl   = document.getElementById("advice-text");

  if (!window.computedResult) {
    alert("Voer eerst een berekening uit.");
    return;
  }

  statusEl.textContent = "Advies wordt gegenereerd op basis van uw gegevens‚Ä¶";

  // üß† FEITENOBJECT (backend-leidend)
  const context = buildAdviceContext(window.computedResult);

  // ‚úèÔ∏è CONCEPTTEKST (frontend-draft)
  const draftText = buildAdviceText(window.computedResult);

  try {
    const res = await fetch(API_BASE + "/generate_advice", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        context: context,
        draft_text: draftText
      })
    });

    const data = await res.json();

    if (!data.advice.includes("Bijlage A")) {
      console.warn("‚ö†Ô∏è Advies gegenereerd zonder bijlagen");
    }

    console.log("GENERATE_ADVICE RESPONSE:", data);

    if (!data || data.error) {
      statusEl.textContent = "Fout bij genereren van advies.";
      return;
    }

    // Backend levert volledige tekst (incl. bijlagen)
    window.computedAdvice = data.advice;

    // üîí Exact weergeven ‚Äî GEEN parsing
    renderAdviceToHtml(data.advice);
    injectResultsIntoAdvice();

    // ‚úÖ Grafiek ook renderen in advies
    renderAdviceChart(window.computedResult);

    statusEl.textContent = "Advies succesvol gegenereerd.";
  } catch (err) {
    statusEl.textContent = "Fout: " + err.message;
  }
});

/* PDF EXPORT */
document.getElementById("btn-download-pdf").addEventListener("click", () => {
  if (!window.computedAdvice || window.computedAdvice.trim() === "") {
  alert("Genereer eerst het advies voordat u de PDF downloadt.");
  return;
}
  
  if (!window.computedResult) {
    alert("Geen berekening beschikbaar. Voer eerst een berekening uit.");
    return;
  }
  
  pdfExport(window.computedResult);
});

  /* ========================================================= */
  /*        GRAFIEK ‚Äî KOSTEN & RENDEMENT OVER LEVENSDUUR       */
  /* ========================================================= */
  function updateCostChart(result) {
    const ctx = document.getElementById("chart").getContext("2d");

    // Oude grafiek opruimen
    if (costChart) {
      costChart.destroy();
    }

    const lifetime =
      parseInt(document.getElementById("battery-lifetime").value || "15");

    const investment =
      parseFloat(document.getElementById("battery-cost").value || "0");

    // üîë huidig gekozen tarief
    const tariff = document.getElementById("tariff-type").value || "enkel";

    // ROI per tarief
    const roi = result.roi_per_tariff[tariff];

    // Jaarlijkse besparing (veilig)
    const yearlySaving =
      roi && isFinite(roi.yearly_saving_eur)
      ? roi.yearly_saving_eur
      : 0;

    // Kosten zonder batterij (B1) en met batterij (C1) ‚Äî PER TARIEF
    const costWithoutBatt =
      result.B1?.[tariff]?.total_cost_eur ?? 0;

    const costWithBatt =
      result.C1?.[tariff]?.total_cost_eur ?? 0;

    let labels = [];
    let withoutBatt = [];
    let withBatt = [];
    let cumulative = [];

    let cum = -investment;

    for (let year = 0; year <= lifetime; year++) {
      labels.push("Jaar " + year);

      if (year === 0) {
        withoutBatt.push(0);
        withBatt.push(-investment);
        cumulative.push(-investment);
      } else {
        withoutBatt.push(costWithoutBatt);
        withBatt.push(costWithBatt);
        cum += yearlySaving;
        cumulative.push(cum);
      }
    }

    costChart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: "Kosten zonder batterij",
            data: withoutBatt,
            borderWidth: 2,
            tension: 0.25
          },
          {
            label: "Kosten met batterij",
            data: withBatt,
            borderWidth: 2,
            tension: 0.25
          },
          {
            label: "Cumulatieve besparing",
            data: cumulative,
            borderWidth: 3,
            borderDash: [6, 6],
            tension: 0.25
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: "bottom"
          },
          tooltip: {
            callbacks: {
              label: (ctx) => "‚Ç¨ " + ctx.parsed.y.toFixed(0)
            }
          }
        },
        scales: {
          y: {
            ticks: {
              callback: (v) => "‚Ç¨ " + v
            }
          }
        }
      }
    });
  }

function renderAdviceChart(result) {
  const canvas = document.getElementById("chart-advice");
  if (!canvas) return;

  const ctx = canvas.getContext("2d");

  // voorkom dubbele grafieken
  if (window.adviceCostChart) {
    window.adviceCostChart.destroy();
  }

  const lifetime =
    parseInt(document.getElementById("battery-lifetime").value || "15");

  const investment =
    parseFloat(document.getElementById("battery-cost").value || "0");

  const tariff =
    document.getElementById("tariff-type").value || "enkel";

  const roi = result.roi_per_tariff?.[tariff];

  const yearlySaving =
    roi && isFinite(roi.yearly_saving_eur)
      ? roi.yearly_saving_eur
      : 0;

  const costWithoutBatt =
    result.B1?.[tariff]?.total_cost_eur ?? 0;

  const costWithBatt =
    result.C1?.[tariff]?.total_cost_eur ?? 0;

  let labels = [];
  let withoutBatt = [];
  let withBatt = [];
  let cumulative = [];

  let cum = -investment;

  for (let year = 0; year <= lifetime; year++) {
    labels.push("Jaar " + year);

    if (year === 0) {
      withoutBatt.push(0);
      withBatt.push(-investment);
      cumulative.push(-investment);
    } else {
      withoutBatt.push(costWithoutBatt);
      withBatt.push(costWithBatt);
      cum += yearlySaving;
      cumulative.push(cum);
    }
  }

  window.adviceCostChart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: "Kosten zonder batterij",
          data: withoutBatt,
          borderWidth: 2,
          tension: 0.25
        },
        {
          label: "Kosten met batterij",
          data: withBatt,
          borderWidth: 2,
          tension: 0.25
        },
        {
          label: "Cumulatieve besparing",
          data: cumulative,
          borderWidth: 3,
          borderDash: [6, 6],
          tension: 0.25
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: "bottom" }
      },
      scales: {
        y: {
          ticks: {
            callback: v => "‚Ç¨ " + v
          }
        }
      }
    }
  });
}
  
</script>
  
<!-- ======================================= -->
<!--       STEPPER PILLS CLICKABLE           -->
<!-- ======================================= -->
<script>
document.querySelectorAll(".stepper .step").forEach((pill, index) => {
  pill.style.cursor = "pointer";

  pill.addEventListener("click", () => {

    // Niet vooruit klikken zonder verplichte profielvelden
    if (index > 1) {
      const annualLoad = parseFloat(document.getElementById("annual-load")?.value || "0");
      const annualPv   = parseFloat(document.getElementById("annual-pv")?.value || "0");
      const profile    = document.getElementById("household-profile")?.value || "";

      if (!isFinite(annualLoad) || annualLoad <= 0 || !isFinite(annualPv) || annualPv < 0 || !profile) {
        alert("Vul eerst Stap 1 volledig in (jaarverbruik, jaaropwek en profiel).");
        return;
      }
    }

    // Niet naar stap 3/4/5 zonder batterijdata
    if (index > 2) {
      const E = document.getElementById("E").value;
      if (!E) {
        alert("Vul eerst de batterijgegevens in bij stap 2.");
        return;
      }
    }

    // Niet naar stap 5 zonder berekening (computedResult)
    if (index === 5 && !window.computedResult) {
      alert("Voer eerst een berekening uit bij stap 4.");
      return;
    }

    activateStep(index);

    if (index === 3) {
      applyTariffDefaultsIfEmpty();
    }
  });
});
</script>  

<script>  
/* DEFAULTS */
window.addEventListener("DOMContentLoaded", () => {
  activateStep(0);
  updateCountryUI();
  wireUnknownToggles();
});
  
</script>
  
<script>
/* ===============================
   SUPABASE LOGIN GATE
   =============================== */

const SUPABASE_URL = "https://sjnfzyvuhizpkziaxdtb.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqbmZ6eXZ1aGl6cGt6aWF4ZHRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwODIwNTIsImV4cCI6MjA4MTY1ODA1Mn0.2TpBDRjKSbdyOX8hh1qG9Y2RqyUBZMb6D0PJGZl-EfQ";

const sb = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

const loginContainer = document.getElementById("login-container");
const appView = document.getElementById("app-view");
const loginStatus = document.getElementById("login-status");

// ===== Signup scherm =====
const signupContainer = document.getElementById("signup-container");
const btnGoToSignup = document.getElementById("go-to-signup");
const btnBackToLogin = document.getElementById("back-to-login");
  
const signupStatus = document.getElementById("signup-status");
const signupFirstName = document.getElementById("signup-firstname");
const signupLastName = document.getElementById("signup-lastname");
const signupCompanyName = document.getElementById("signup-company");
const signupPhone = document.getElementById("signup-phone");
const signupEmail = document.getElementById("signup-email");
const signupPassword = document.getElementById("signup-password");
const signupPassword2 = document.getElementById("signup-password-confirm");
const btnCreateAccount = document.getElementById("btn-signup-submit");

// ============================
// CHECK LOGIN BIJ LADEN
// ============================
sb.auth.getSession().then(({ data }) => {
  if (data && data.session) {
    const user = data.session.user;

    loginContainer.style.display = "none";
    appView.style.display = "block";

    // üë§ toon e-mail
    const emailEl = document.getElementById("user-email");
    if (emailEl) {
      emailEl.textContent = user.email;
    }
  } else {
    loginContainer.style.display = "block";
    signupContainer.style.display = "none";
    appView.style.display = "none";
  }
});

  // ============================
  // SCHERM WISSELEN
  // ============================

  // Naar signup scherm
  btnGoToSignup.addEventListener("click", () => {
    loginContainer.style.display = "none";
    signupContainer.style.display = "block";
  });

  // Terug naar login scherm
  btnBackToLogin.addEventListener("click", () => {
    signupContainer.style.display = "none";
    loginContainer.style.display = "block";
  });

// ============================
// LOGIN
// ============================
document.getElementById("btn-login").addEventListener("click", async () => {
  const emailEl = document.getElementById("login-email");
  const passEl  = document.getElementById("login-password");

  if (!emailEl || !passEl) {
    loginStatus.textContent = "Loginvelden ontbreken.";
    loginStatus.className = "status error";
    return;
  }

  const email = emailEl.value.trim();
  const password = passEl.value;

  if (!email || !password) {
    loginStatus.textContent = "Vul e-mailadres en wachtwoord in.";
    loginStatus.className = "status error";
    return;
  }

  loginStatus.textContent = "Inloggen‚Ä¶";
  loginStatus.className = "status";

  const { error } = await sb.auth.signInWithPassword({
    email,
    password
  });

  if (error) {
    loginStatus.textContent = error.message;
    loginStatus.className = "status error";
    return;
  }

  loginContainer.style.display = "none";
  appView.style.display = "block";
});

// ============================
// SIGNUP
// ============================
// ============================
// SIGNUP (apart scherm)
// ============================
btnCreateAccount.addEventListener("click", async () => {
  signupStatus.textContent = "";
  signupStatus.className = "status";

  if (
    !signupFirstName.value.trim() ||
    !signupLastName.value.trim() ||
    !signupCompanyName.value.trim() ||
    !signupEmail.value.trim() ||
    !signupPhone.value.trim()
  ) {
    signupStatus.textContent = "Alle velden zijn verplicht.";
    signupStatus.className = "status error";
    return;
  }

  if (!signupEmail.value.trim()) {
    signupStatus.textContent = "Vul uw e-mailadres in.";
    signupStatus.className = "status error";
    return;
  }

  if (signupPassword.value.length < 6) {
    signupStatus.textContent = "Wachtwoord moet minimaal 6 tekens zijn.";
    signupStatus.className = "status error";
    return;
  }

  if (signupPassword.value !== signupPassword2.value) {
    signupStatus.textContent = "Wachtwoorden komen niet overeen.";
    signupStatus.className = "status error";
    return;
  }

  signupStatus.textContent = "Account aanmaken‚Ä¶";

  const { data, error } = await sb.auth.signUp({
    email: signupEmail.value.trim(),
    password: signupPassword.value
  });

  if (error) {
    signupStatus.textContent = error.message;
    signupStatus.className = "status error";
    return;
  }

  const userId = data?.user?.id;

  if (userId) {
    const { error: profileError } = await sb
      .from("profiles")
      .insert([{
        id: userId,
        full_name: `${signupFirstName.value.trim()} ${signupLastName.value.trim()}`,
        company_name: signupCompanyName.value.trim(),
      }]);

    if (profileError) {
      signupStatus.textContent =
        "Account aangemaakt, maar profiel opslaan mislukt.";
      signupStatus.className = "status error";
      return;
    }
  }

  signupStatus.textContent = "Account aangemaakt ‚úî U kunt nu inloggen.";
  signupStatus.className = "status success";

  document.getElementById("login-email").value = signupEmail.value.trim();
  document.getElementById("login-password").value = "";

  setTimeout(() => {
    signupContainer.style.display = "none";
    loginContainer.style.display = "block";
  }, 800);
});

// ============================
// LOGOUT HANDLER
// ============================
document
  .getElementById("btn-logout")
  .addEventListener("click", async () => {

    await sb.auth.signOut();

    // ‚úÖ harde reset zodat login weer altijd werkt (ook mobiel)
    window.location.reload();

  });
  
</script>
</body>
</html>
