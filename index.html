<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Thuisbatterij Besparingscalculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --bg: #f5f7fa;
      --card-bg: #ffffff;
      --text: #1e293b;
      --muted: #64748b;
      --border: #e2e8f0;
      --danger: #dc2626;
      --success: #15803d;
      --highlight: #dbeafe;
    }

    * { box-sizing: border-box; }
    body {
      margin:0;
      font-family: system-ui, sans-serif;
      background:#f5f7fa;
      color:var(--text);
    }

    .page {
      max-width:1200px;
      margin:0 auto;
      padding:32px 18px 60px;
    }

    .title { font-size:2rem; font-weight:700; }
    .subtitle { margin-top:4px; font-size:1rem; color:var(--muted); }

    /* STEPPER */
    .stepper { display:flex; gap:10px; margin:24px 0; flex-wrap:wrap; }
    .step {
      display:flex; align-items:center; gap:8px;
      padding:7px 14px; border-radius:999px;
      background:#fff; border:1px solid var(--border);
      font-size:0.85rem; color:var(--muted);
    }
    .step.active {
      background:var(--highlight);
      border-color:var(--primary);
      color:var(--primary-dark);
      font-weight:600;
    }
    .badge {
      width:22px; height:22px; border-radius:999px;
      border:1px solid currentColor;
      display:flex; align-items:center; justify-content:center;
      font-size:0.8rem;
    }

    .layout {
      display:grid;
      grid-template-columns:minmax(0,3fr) minmax(0,2fr);
      gap:24px;
    }
    @media(max-width:900px) {
      .layout { grid-template-columns:1fr; }
    }

    .card {
      background:var(--card-bg);
      border-radius:16px;
      padding:24px;
      border:1px solid var(--border);
      box-shadow:0 24px 60px rgba(0,0,0,0.04);
    }

    h2 { margin:0 0 18px 0; font-size:1.4rem; }

    .field { margin-bottom:16px; }
    .field label { display:block; margin-bottom:7px; font-weight:600; }

    /* STEP 0 SELECTIE */
    .choice-row {
      display:flex;
      align-items:center;
      gap:10px;
      padding:6px 0;
      font-size:0.95rem;
      cursor:pointer;
    }
    .choice-row input[type="radio"] {
      width:18px; height:18px;
    }
    .choice-row span { flex:1; }

    input, select {
      width:100%;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid var(--border);
      font-size:0.9rem;
      background:#fafbfc;
    }

    input:focus, select:focus {
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 1px #bfdbfe;
      background:#fff;
    }

    button {
      border:none;
      border-radius:8px;
      padding:10px 18px;
      font-size:0.9rem;
      cursor:pointer;
    }
    .btn-primary { background:var(--primary); color:white; }
    .btn-secondary { background:#e2e8f0; color:#1e293b; }
    .btn-primary:disabled { opacity:0.5; cursor:not-allowed; }

    .status {
      font-size:0.8rem;
      color:var(--muted);
      margin-top:8px;
    }
    .status.error { color:var(--danger); }
    .status.success { color:var(--success); }

    table {
      width:100%;
      border-collapse:collapse;
      margin-top:14px;
      font-size:0.85rem;
    }
    th,td {
      border:1px solid var(--border);
      padding:8px 10px;
      text-align:right;
    }
    th:first-child, td:first-child { text-align:left; }
    th { background:#f1f5f9; font-weight:600; }
    td.highlight { background:var(--highlight); font-weight:700; }

    .results-summary {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:12px;
      margin-bottom:16px;
    }
    .result-tile {
      border-radius:12px;
      border:1px solid var(--border);
      padding:12px 14px;
      background:#f8fafc;
    }
    .result-tile .label {
      font-size:0.8rem;
      color:var(--muted);
      margin-bottom:4px;
    }
    .result-tile .value {
      font-size:1.1rem;
      font-weight:700;
    }

    #chart { margin-top:20px; }

    /* ===== TOOLTIP STYLING ===== */
.info-icon {
  cursor: help;
  margin-left: 6px;
  color: #3b82f6;
  font-weight: bold;
  position: relative;
}

.info-icon:hover::after {
  content: attr(data-tooltip);
  position: absolute;
  top: 20px;
  left: 0;
  background: #1f2937;
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  width: 260px;
  z-index: 999;
  font-size: 13px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
    
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
<div class="page">

<header>
  <div class="title">Thuisbatterij Besparingscalculator</div>
  <div class="subtitle">Nauwkeurige berekening met CSV-data en professioneel adviesrapport.</div>
</header>

<div class="stepper">
  <div class="step active" id="step-pill-0"><div class="badge">0</div> Start</div>
  <div class="step" id="step-pill-1"><div class="badge">1</div> CSV & Tarief</div>
  <div class="step" id="step-pill-2"><div class="badge">2</div> Batterij</div>
  <div class="step" id="step-pill-3"><div class="badge">3</div> Tarieven</div>
  <div class="step" id="step-pill-4"><div class="badge">4</div> Resultaat</div>
  <div class="step" id="step-pill-5"><div class="badge">5</div> Advies</div>
</div>

<div class="layout">
<div class="card" id="wizard-container">

  <!-- ======================= -->
<!--    STEP 0               -->
<!-- ======================= -->
<div id="step-0">
  <h2>Stap 0 ¬∑ Kies uw berekeningstype</h2>

  <label class="choice-row">
    <input type="radio" name="calc-type" value="snelle">
    <span>Snelle inschatting (nog niet geactiveerd)</span>
  </label>

  <label class="choice-row">
    <input type="radio" name="calc-type" value="nauwkeurige">
    <span>Nauwkeurige CSV-berekening</span>
  </label>

  <br>
  <button class="btn-primary" id="to-step-0-next">Volgende</button>
</div>

<!-- ======================= -->
<!--    STEP 1               -->
<!-- ======================= -->
<div id="step-1" style="display:none;">
  <h2>Stap 1 ¬∑ Tarief & CSV-bestanden</h2>

  <div class="field">
    <label>Land</label>
    <select id="country">
      <option value="NL">Nederland</option>
      <option value="BE">Belgi√´</option>
    </select>
  </div>

  <div class="field">
    <label>Huidig tarief</label>
    <select id="tariff-type">
      <option value="enkel">Enkel</option>
      <option value="dag_nacht">Dag/Nacht</option>
      <option value="dynamisch">Dynamisch</option>
    </select>
  </div>

  <div class="field">
    <label>load.csv</label>
    <input type="file" id="file-load" accept=".csv">
  </div>

  <div class="field">
    <label>pv.csv</label>
    <input type="file" id="file-pv" accept=".csv">
  </div>

  <div class="field">
    <label>prices.csv (dynamisch tarief)</label>
    <input type="file" id="file-prices" accept=".csv">
  </div>

  <div id="csv-status" class="status">Nog geen CSV verwerkt.</div>

  <br>
  <button class="btn-primary" id="btn-parse-csv">CSV verwerken</button>
  <button class="btn-secondary" id="to-step-2" disabled>Volgende</button>
</div>

<!-- ======================= -->
<!--    STEP 2               -->
<!-- ======================= -->
<div id="step-2" style="display:none;">
  <h2>Stap 2 ¬∑ Batterij</h2>

  <!-- OPSLAGCAPACITEIT -->
  <div class="field">
    <label>
      Opslagcapaciteit | E (kWh)
      <span class="info-icon"
            data-tooltip="De totale hoeveelheid energie die de batterij kan opslaan. 1 kWh = ongeveer 1 uur lang 1000 watt. Een hogere capaciteit betekent meer opslag voor later gebruik.">
        ‚Ñπ
      </span>
    </label>
    <input id="E" type="number" min="0" step="0.1">
  </div>

  <!-- VERMOGEN -->
  <div class="field">
    <label>
      Laad/ontlaadvermogen | P (kW)
      <span class="info-icon"
            data-tooltip="Het maximale vermogen waarmee de batterij kan laden of ontladen. Een hoger vermogen betekent sneller reageren. Voor Belgi√´ is dit belangrijk voor peak-shaving.">
        ‚Ñπ
      </span>
    </label>
    <input id="P" type="number" min="0" step="0.1">
  </div>

  <!-- DOD -->
  <div class="field">
    <label>
      Diepte van Ontlading | DoD (%)
      <span class="info-icon"
            data-tooltip="Het percentage van de batterijcapaciteit dat je veilig kunt gebruiken. Bij 90% DoD kun je 90% van de totale capaciteit benutten.">
        ‚Ñπ
      </span>
    </label>
    <input id="DoD" type="number" min="0" max="100">
  </div>

  <!-- ROUND TRIP EFFICIENCY -->
  <div class="field">
    <label>
      Round-Trip Effici√´ntie | Œ∑_rt (%)
      <span class="info-icon"
            data-tooltip="Geeft aan hoeveel energie overblijft na laden √©n ontladen. Bij 90% effici√´ntie levert 1 kWh laden ongeveer 0.9 kWh bruikbaar vermogen op.">
        ‚Ñπ
      </span>
    </label>
    <input id="eta_rt" type="number" min="0" max="100">
  </div>


  <!-- CAPACITEITSTARIEF ‚Äî WORDT BIJ NL AUTOMATISCH VERBORGEN VIA updateCountryUI() -->
  <div class="field">
    <label>
      Capaciteitstarief (‚Ç¨/kW/jaar)
      <span class="info-icon"
            data-tooltip="Alleen Belgi√´ (Fluvius). Kosten per kW maandpiek. Een batterij kan pieken verlagen en zo besparen op dit tarief.">
        ‚Ñπ
      </span>
    </label>
    <input id="capacity-tariff" type="number" min="0" step="0.1" value="0">
  </div>

  <!-- INVESTERING -->
  <div class="field">
    <label>
      Investering Batterij (‚Ç¨)
      <span class="info-icon"
            data-tooltip="De totale aankoopprijs inclusief installatie en omvormer. Dit wordt gebruikt om de terugverdientijd te berekenen.">
        ‚Ñπ
      </span>
    </label>
    <input id="battery-cost" type="number" min="0" step="1">
  </div>

  <!-- LEVENSDUUR BATTERIJ -->
  <div class="field">
    <label>
      Levensduur batterij (jaar)
      <span class="info-icon"
          data-tooltip="De periode waarover de batterij economisch wordt beoordeeld. Dit be√Ønvloedt de totale besparing, ROI en terugverdientijd.">
        ‚Ñπ
      </span>
    </label>
    <select id="battery-lifetime">
      <option value="10">10 jaar</option>
      <option value="15" selected>15 jaar</option>
      <option value="20">20 jaar</option>
      <option value="25">25 jaar</option>
    </select>
  </div>
  
  <!-- DEGRADATIE -->
  <div class="field">
    <label>
      Degradatie per jaar (%)
      <span class="info-icon"
        data-tooltip="Het jaarlijkse capaciteitsverlies van de batterij. Bij 2% degradatie daalt 10 kWh naar ongeveer 9 kWh bruikbaar vermogen na 5 jaar.">
        ‚Ñπ
      </span>
    </label>
    <input id="battery-degradation" type="number" min="0" max="10" step="0.1" value="2">
  </div>

  <button class="btn-secondary" id="back-to-1">Vorige</button>
  <button class="btn-primary" id="to-step-3">Volgende</button>
</div>

<!-- ======================= -->
<!--    STEP 3               -->
<!-- ======================= -->
<div id="step-3" style="display:none;">
  <h2>Stap 3 ¬∑ Tarieven</h2>

  <h3>Enkel tarief</h3>
  <div class="field">
    <label>Importprijs (‚Ç¨/kWh)</label>
    <input id="p_enkel_imp" type="number" step="0.01">
  </div>
  <div class="field">
    <label>Exportprijs (‚Ç¨/kWh)</label>
    <input id="p_enkel_exp" type="number" step="0.01">
  </div>

  <h3>Dag/Nacht tarief</h3>
  <div class="field">
    <label>Dagprijs (‚Ç¨/kWh)</label>
    <input id="p_dag" type="number" step="0.01">
  </div>
  <div class="field">
    <label>Nachtprijs (‚Ç¨/kWh)</label>
    <input id="p_nacht" type="number" step="0.01">
  </div>
  <div class="field">
    <label>Exportprijs (‚Ç¨/kWh)</label>
    <input id="p_exp_dn" type="number" step="0.01">
  </div>

  <h3>Dynamisch tarief</h3>
  <div class="field">
    <label>Exportprijs (‚Ç¨/kWh)</label>
    <input id="p_export_dyn" type="number" step="0.01">
  </div>

  <h3>Terugleverkosten (leverancierskosten 2025)</h3>

  <!-- VASTRECHT -->
  <h3>Vaste contractkosten</h3>

  <div class="field">
    <label>
      Vastrecht (‚Ç¨/jaar)
      <span class="info-icon"
          data-tooltip="Vaste jaarlijkse kosten van uw energieleverancier voor de aansluiting. Dit bedrag is onafhankelijk van uw verbruik, maar telt mee in alle scenario‚Äôs.">
        ‚Ñπ
      </span>
    </label>
    <input id="fixed-cost" type="number" min="0" step="0.01" value="0">
  </div>

  <div class="field">
    <label>Terugleverkosten per maand (‚Ç¨/maand)</label>
    <input id="tlv_monthly_fee" type="number" step="0.01" value="0">
  </div>

  <div class="field">
    <label>Terugleverkosten per kWh (‚Ç¨/kWh boven staffel)</label>
    <input id="tlv_per_kwh" type="number" step="0.001" value="0">
  </div>

  <div class="field">
    <label>Gratis teruglevering (kWh/jaar)</label>
    <input id="tlv_free_kwh" type="number" step="1" value="0">
  </div>

  <div class="field">
    <label>Kosten per kW omvormer (‚Ç¨/kW per maand)</label>
    <input id="tlv_per_kw_inverter" type="number" step="0.01" value="0">
  </div>

  <div id="compute-status" class="status"></div>

  <div id="dyn-fallback-note" class="status" style="display:none;">
    Dynamische prijzen werden gesimuleerd op basis van historische marktdata (APX-profiel).
  </div>

  <button class="btn-secondary" id="back-to-2">Vorige</button>
  <button class="btn-primary" id="btn-compute">Bereken</button>
</div>

<!-- ======================= -->
<!--    STEP 4               -->
<!-- ======================= -->
<div id="step-4" style="display:none;">
  <h2>Stap 4 ¬∑ Resultaten</h2>

<div class="results-summary">
  <div class="result-tile">
    <div class="label">Huidige situatie (A1)</div>
    <div class="value" id="res-A1">‚Äì</div>
  </div>
  <div class="result-tile">
  <div class="label">
    Zonder Saldering | Zonder Batterij | B1<br>
    <small id="res-B1-tariff-label" style="color:#64748b;"></small>
  </div>
  <div class="value" id="res-B1">‚Äì</div>
</div>

<div class="result-tile">
  <div class="label">
    Zonder Saldering | Met Batterij | C1<br>
    <small id="res-C1-tariff-label" style="color:#64748b;"></small>
  </div>
  <div class="value" id="res-C1">‚Äì</div>
</div>

  <!-- NIEUW: BESPARING / PAYBACK / ROI -->
  <div class="result-tile">
    <div class="label">Besparing per jaar</div>
    <div class="value" id="res-savings">‚Äì</div>
  </div>
  <div class="result-tile">
    <div class="label">
      Terugverdientijd<br>
      <small style="color:#64748b">incl. batterijdegradatie</small>
    </div>
    <div class="value" id="res-payback">‚Äì</div>
  </div>
  <div class="result-tile">
    <div class="label">
      ROI (%)<br>
      <small style="color:#64748b">incl. batterijdegradatie</small>
    </div>
    <div class="value" id="res-roi">‚Äì</div>
  </div>
  <div class="result-tile">
  <div class="label">Piek zonder batterij (kW)</div>
  <div class="value" id="res-peak-no">‚Äì</div>
</div>

  

<div class="result-tile">
  <div class="label">Piek met batterij (kW)</div>
  <div class="value" id="res-peak-yes">‚Äì</div>
</div>

<div class="result-tile">
  <div class="label">Besparing capaciteitstarief / jaar</div>
  <div class="value" id="res-peak-saving">‚Äì</div>
</div>
</div>

  <h3>Tariefmatrix (jaarlijkse kosten)</h3>
  <table>
    <tr>
      <th>Scenario</th>
      <th>Enkel</th>
      <th>Dag/Nacht</th>
      <th>Dynamisch</th>
    </tr>
    <tr>
      <td>Huidige situatie</td>
      <td id="A1-enkel">‚Äì</td>
      <td id="A1-dn">‚Äì</td>
      <td id="A1-dyn">‚Äì</td>
    </tr>
    <tr>
      <td>Toekomst zonder batterij</td>
      <td id="B1-enkel">‚Äì</td>
      <td id="B1-dn">‚Äì</td>
      <td id="B1-dyn">‚Äì</td>
    </tr>
    <tr>
      <td>Toekomst met batterij</td>
      <td id="C1-enkel">‚Äì</td>
      <td id="C1-dn">‚Äì</td>
      <td id="C1-dyn">‚Äì</td>
    </tr>
  </table>

  <h3>Energie-inzichten (kWh)</h3>
  <table>
    <tr>
      <th></th>
      <th>Enkel</th>
      <th>Dag/Nacht</th>
      <th>Dynamisch</th>
    </tr>
    <tr>
      <td>B1 Import</td>
      <td id="B1-imp-enkel">‚Äì</td>
      <td id="B1-imp-dn">‚Äì</td>
      <td id="B1-imp-dyn">‚Äì</td>
    </tr>
    <tr>
      <td>B1 Export</td>
      <td id="B1-exp-enkel">‚Äì</td>
      <td id="B1-exp-dn">‚Äì</td>
      <td id="B1-exp-dyn">‚Äì</td>
    </tr>
    <tr>
      <td>C1 Import</td>
      <td id="C1-imp-enkel">‚Äì</td>
      <td id="C1-imp-dn">‚Äì</td>
      <td id="C1-imp-dyn">‚Äì</td>
    </tr>
    <tr>
      <td>C1 Export</td>
      <td id="C1-exp-enkel">‚Äì</td>
      <td id="C1-exp-dn">‚Äì</td>
      <td id="C1-exp-dyn">‚Äì</td>
    </tr>
  </table>

  <br>
  <button class="btn-primary" id="btn-download-pdf" style="display:none;">
    üìÑ Download PDF
  </button>

  <button class="btn-secondary" id="to-step-5" style="margin-left:8px;">
    Persoonlijk advies bekijken
  </button>
</div>

<!-- ======================= -->
<!--    STEP 5 ¬∑ ADVIES      -->
<!-- ======================= -->
<div id="step-5" style="display:none;">
  <h2>Stap 5 ¬∑ Persoonlijk advies</h2>

  <p class="status" id="advice-status">
    Klik op ‚ÄúGenereer advies‚Äù om een tekstueel advies te maken op basis van uw gegevens.
  </p>

  <!-- Groot tekstvak met het advies -->
  <div class="field">
    <label>Adviesrapport</label>
    <textarea id="advice-text" rows="14" style="width:100%; padding:12px; border-radius:12px; border:1px solid var(--border); font-size:0.9rem;"></textarea>
  </div>

  <div style="display:flex; gap:8px; flex-wrap:wrap;">
    <button class="btn-secondary" id="back-to-4">Terug naar resultaten</button>
    <button class="btn-primary" id="btn-generate-advice">Genereer advies</button>
  </div>

  <p class="status" style="margin-top:10px; font-size:0.8rem; color:var(--muted);">
    Tip: u kunt deze tekst rechtstreeks kopi√´ren naar een offerte of rapport.
  </p>
</div>

</div> <!-- wizard end -->

<!-- ======================= -->
<!--   RECHTERKOLOM GRAFIEK  -->
<!-- ======================= -->
<div class="card">
  <h2>Grafiek ‚Äî Kosten & rendement over levensduur</h2>
  <canvas id="chart" height="140"></canvas>
</div>

</div> <!-- layout -->
</div> <!-- page -->

  <!-- ========================================================= -->
<!-- ===================  PDF HELPER FUNCTIES  ================ -->
<!-- ========================================================= -->
<script>
function pdfDrawTable(doc, startX, startY, rows, colWidths) {
  let y = startY;
  const rowHeight = 18;

  doc.setFont("helvetica", "bold");
  for (let i = 0; i < rows[0].length; i++) {
    const offset = colWidths.slice(0, i).reduce((a,b)=>a+b,0);
    doc.text(String(rows[0][i]), startX + offset + 4, y);
  }
  y += rowHeight;

  doc.setFont("helvetica","normal");

  for (let r = 1; r < rows.length; r++) {
    let x = startX;
    for (let c = 0; c < rows[r].length; c++) {
      doc.text(String(rows[r][c]), x + 4, y);
      x += colWidths[c];
    }
    y += rowHeight;
  }

  const totalWidth = colWidths.reduce((a,b)=>a+b,0);
  const totalHeight = rowHeight * rows.length;
  doc.rect(startX, startY - rowHeight, totalWidth, totalHeight);

  return y + 10;
}

function pdfHeader(doc) {
  doc.setFont("helvetica", "bold");
  doc.setFontSize(22);
  doc.text("Thuisbatterij Adviesrapport", 40, 60);

  doc.setFontSize(11);
  doc.setFont("helvetica","normal");
  doc.text("Gegenereerd op: " + new Date().toLocaleDateString("nl-NL"), 40, 82);
}

function pdfIntro(doc) {
  doc.setFont("helvetica","bold");
  doc.setFontSize(16);
  doc.text("1. Inleiding", 40, 120);

  doc.setFont("helvetica","normal");
  doc.setFontSize(12);

  const intro =
    "Dit rapport bevat een volledige financi√´le en energetische analyse van uw woning " +
    "onder drie tariefstructuren (Enkel, Dag/Nacht, Dynamisch) en in drie scenario‚Äôs: " +
    "huidige situatie, toekomst zonder thuisbatterij en toekomst met thuisbatterij.";

  const lines = doc.splitTextToSize(intro, 520);
  doc.text(lines, 40, 145);
}

function pdfTariffMatrix(doc) {
  doc.addPage();
  doc.setFont("helvetica","bold");
  doc.setFontSize(16);
  doc.text("2. Tarievenoverzicht", 40, 60);

  const rows = [
    ["Tarief", "Importprijs", "Exportprijs"],
    [
      "Enkel",
      document.getElementById("p_enkel_imp").value + " ‚Ç¨/kWh",
      document.getElementById("p_enkel_exp").value + " ‚Ç¨/kWh"
    ],
    [
      "Dag/Nacht",
      document.getElementById("p_dag").value + " / " +
      document.getElementById("p_nacht").value + " ‚Ç¨/kWh",
      document.getElementById("p_exp_dn").value + " ‚Ç¨/kWh"
    ],
    [
      "Dynamisch",
      "Uit CSV (uurprijzen)",
      document.getElementById("p_export_dyn").value + " ‚Ç¨/kWh"
    ]
  ];

  pdfDrawTable(doc, 40, 100, rows, [160, 180, 180]);
}

function pdfCostMatrix(doc, data) {
  doc.addPage();
  doc.setFont("helvetica","bold");
  doc.setFontSize(16);
  doc.text("3. Kostenmatrix (jaarlijkse kosten)", 40, 60);

  const rows = [
    ["Scenario", "Enkel", "Dag/Nacht", "Dynamisch"],
    ["Huidige situatie",
      fmtEuro(data.A1_per_tariff.enkel),
      fmtEuro(data.A1_per_tariff.dag_nacht),
      fmtEuro(data.A1_per_tariff.dynamisch)
    ],
    ["Toekomst zonder batterij",
      fmtEuro(data.S2_enkel.total_cost),
      fmtEuro(data.S2_dn.total_cost),
      fmtEuro(data.S2_dyn.total_cost)
    ],
    ["Toekomst met batterij",
      fmtEuro(data.S3_enkel.total_cost),
      fmtEuro(data.S3_dn.total_cost),
      fmtEuro(data.S3_dyn.total_cost)
    ]
  ];

  pdfDrawTable(doc, 40, 100, rows, [160, 140, 140, 140]);
}

function pdfEnergyTables(doc, data) {
  doc.addPage();
  doc.setFont("helvetica","bold");
  doc.setFontSize(16);
  doc.text("4. Energie-inzichten (kWh)", 40, 60);

  const imports = [
    ["Scenario", "Enkel", "Dag/Nacht", "Dynamisch"],
    ["B1 Import",
      data.S2_enkel.import.toFixed(1),
      data.S2_dn.import.toFixed(1),
      data.S2_dyn.import.toFixed(1)
    ],
    ["C1 Import",
      data.S3_enkel.import.toFixed(1),
      data.S3_dn.import.toFixed(1),
      data.S3_dyn.import.toFixed(1)
    ]
  ];

  let y = pdfDrawTable(doc, 40, 100, imports, [160, 140, 140, 140]);

  const exports = [
    ["Scenario", "Enkel", "Dag/Nacht", "Dynamisch"],
    ["B1 Export",
      data.S2_enkel.export.toFixed(1),
      data.S2_dn.export.toFixed(1),
      data.S2_dyn.export.toFixed(1)
    ],
    ["C1 Export",
      data.S3_enkel.export.toFixed(1),
      data.S3_dn.export.toFixed(1),
      data.S3_dyn.export.toFixed(1)
    ]
  ];

  pdfDrawTable(doc, 40, y + 20, exports, [160, 140, 140, 140]);
}

function pdfBatteryStats(doc, data) {
  doc.addPage();
  doc.setFont("helvetica","bold");
  doc.setFontSize(16);
  doc.text("5. Batterijprestaties", 40, 60);

  const s3 = data.S3_enkel || {import:0, export:0};

  const E   = parseFloat(document.getElementById("E").value || "0");
  const P   = parseFloat(document.getElementById("P").value || "0");
  const DoD = parseFloat(document.getElementById("DoD").value || "0");
  const eta = parseFloat(document.getElementById("eta_rt").value || "0");

  const rows = [
    ["Parameter", "Waarde"],
    ["Import met batterij (kWh)", s3.import.toFixed(1)],
    ["Export met batterij (kWh)", s3.export.toFixed(1)],
    ["Batterijcapaciteit (kWh)", E || "‚Äì"],
    ["Vermogen (kW)", P || "‚Äì"],
    ["Depth of Discharge (%)", DoD || "‚Äì"],
    ["Round-trip effici√´ntie (%)", eta || "‚Äì"]
  ];

  pdfDrawTable(doc, 40, 100, rows, [260, 260]);
}

function pdfAdviceSection(doc, adviceText) {
  // Geen advies? Dan geen extra pagina.
  if (!adviceText || adviceText.trim() === "") return;

  doc.addPage();
  doc.setFont("helvetica","bold");
  doc.setFontSize(16);
  doc.text("6. Persoonlijk advies", 40, 60);

  doc.setFont("helvetica","normal");
  doc.setFontSize(11);

  // Lange tekst netjes afbreken
  const lines = doc.splitTextToSize(adviceText, 520);
  doc.text(lines, 40, 90);
}

function pdfExport(data) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"a4" });

  pdfHeader(doc);
  pdfIntro(doc);
  pdfTariffMatrix(doc);
  pdfCostMatrix(doc, data);
  pdfEnergyTables(doc, data);
  pdfBatteryStats(doc, data);

  // ‚úÖ Adviestekst ophalen: eerst uit textarea, dan uit computedAdvice
  const adviceFromBox =
    document.getElementById("advice-text")
      ? document.getElementById("advice-text").value
      : "";

  const adviceText =
    (adviceFromBox && adviceFromBox.trim() !== "")
      ? adviceFromBox
      : (window.computedAdvice || "");

  // ‚úÖ Nieuwe adviespagina toevoegen (alleen als er tekst is)
  pdfAdviceSection(doc, adviceText);

  doc.save("Thuisbatterij-adviesrapport.pdf");
}
</script>

<!-- ======================================= -->
<!--       STEPPER PILLS CLICKABLE           -->
<!-- ======================================= -->
<script>
document.querySelectorAll(".stepper .step").forEach((pill, index) => {
  pill.style.cursor = "pointer";

  pill.addEventListener("click", () => {

    // Niet vooruit klikken zonder CSV-data
    if (index > 1 && (!parsedData || !parsedData.load_kwh)) {
      alert("Voltooi eerst stap 1 (CSV verwerken).");
      return;
    }

    // Niet naar stap 3/4/5 zonder batterijdata
    if (index > 2) {
      const E = document.getElementById("E").value;
      if (!E) {
        alert("Vul eerst de batterijgegevens in bij stap 2.");
        return;
      }
    }

    // Niet naar stap 5 zonder berekening (computedResult)
    if (index === 5 && !window.computedResult) {
      alert("Voer eerst een berekening uit bij stap 4.");
      return;
    }

    activateStep(index);
  });
});
</script>  
  
<!-- ========================================================= -->
<!-- =============   HOOFDLOGICA / APP     =================== -->
<!-- ========================================================= -->
<script>
const API_BASE = "https://batteryengine-server.onrender.com";
let parsedData = {};
let costChart = null;

function getTariffLabel(code) {
  switch (code) {
    case "enkel":
      return "Enkel tarief";
    case "dag_nacht":
      return "Dag/Nacht tarief";
    case "dynamisch":
      return "Dynamisch tarief";
    default:
      return code;
  }
}
  
/* ----------------------------- */
/*       TARIEF DYNAMISCHE LOGICA */
/* ----------------------------- */

function updatePricesVisibility() {
  const tarief = document.getElementById("tariff-type").value;
  const priceFileField = document.getElementById("file-prices");
  const priceFileLabel = priceFileField.parentElement;

  // ALTIJD zichtbaar, zoals je vroeg
  priceFileLabel.style.display = "block";

  // MAAR: alleen verplicht / foutmelding bij dynamisch
  if (tarief === "dynamisch") {
    priceFileLabel.querySelector("label").textContent =
      "prices.csv (verplicht bij dynamisch)";
  } else {
    priceFileLabel.querySelector("label").textContent =
      "prices.csv (alleen voor dynamisch)";
  }
}

document.getElementById("tariff-type").addEventListener("change", updatePricesVisibility);
document.getElementById("country").addEventListener("change", updateCountryUI);

function updateCountryUI() {
  const country = document.getElementById("country").value;

  const capacityField = document.getElementById("capacity-tariff").parentElement;

  const tilePeakNo  = document.getElementById("res-peak-no").parentElement;
  const tilePeakYes = document.getElementById("res-peak-yes").parentElement;
  const tilePeakSav = document.getElementById("res-peak-saving").parentElement;

  if (country === "NL") {
    capacityField.style.display = "none";
    tilePeakNo.style.display  = "none";
    tilePeakYes.style.display = "none";
    tilePeakSav.style.display = "none";
  } else {
    capacityField.style.display = "block";
    
    tilePeakNo.style.display  = "block";
    tilePeakYes.style.display = "block";
    tilePeakSav.style.display = "block";
  }
}

document.getElementById("country").addEventListener("change", updateCountryUI);

/* ----------------------------- */
/*       WIZARD STAPPEN          */
/* ----------------------------- */
function activateStep(n) {
  for (let i = 0; i < 6; i++) {
    const pill = document.getElementById("step-pill-" + i);
    const step = document.getElementById("step-" + i);
    if (pill) pill.classList.toggle("active", i === n);
    if (step) step.style.display = (i === n) ? "block" : "none";
  }
}

function fmtEuro(x) {
  const v = Number(x);
  if (!isFinite(v)) return "‚Äì";
  return "‚Ç¨ " + v.toFixed(2).replace(".", ",");
}


/* ----------------------------- */
/*      CSV VERWERKEN            */
/* ----------------------------- */
document.getElementById("btn-parse-csv").addEventListener("click", async () => {
  const loadFile   = document.getElementById("file-load").files[0];
  const pvFile     = document.getElementById("file-pv").files[0];
  const pricesFile = document.getElementById("file-prices").files[0];
  const status     = document.getElementById("csv-status");
  const tarief     = document.getElementById("tariff-type").value;

  // ---- VALIDATIE ----
  if (!loadFile || !pvFile) {
    status.textContent = "Load.csv en pv.csv zijn verplicht.";
    status.className = "status error";
    return;
  }

  if (tarief === "dynamisch" && !pricesFile) {
    status.textContent = "Prices.csv is verplicht bij dynamisch tarief.";
    status.className = "status error";
    return;
  }

  status.textContent = "Verwerken‚Ä¶";
  status.className = "status";

  try {
    const [loadText, pvText, pricesText] = await Promise.all([
      loadFile.text(),
      pvFile.text(),
      pricesFile ? pricesFile.text() : ""   // optioneel toegestaan
    ]);

    const res = await fetch(API_BASE + "/parse_csv", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({
        load_file: loadText,
        pv_file: pvText,
        prices_file: pricesText
      })
    });

    const data = await res.json();

    if (!data || data.error) {
      if (data && data.error === "NOT_ENOUGH_DATA_FOR_FLUVIUS") {
        status.textContent =
          "Uw CSV bevat te weinig datapunten. Gebruik een jaarprofiel (minimaal ¬±30.000 kwartierwaarden).";
      } else {
        status.textContent =
          "Fout bij verwerken van CSV (controleer formaat en scheidingstekens).";
      }
      status.className = "status error";
      return;
    }

    // Globaal maken zodat adviesmodule het kan lezen
    window.parsedData = data;

// Lokale alias zodat bestaande code blijft werken
    parsedData = window.parsedData;
    
    status.textContent = "CSV verwerkt ‚úî (" + data.load_kwh.length + " records)";
    status.className = "status success";
    document.getElementById("to-step-2").disabled = false;

  } catch (err) {
    status.textContent = "Fout: " + err.message;
    status.className = "status error";
  }
});


/* ----------------------------- */
/*      NAVIGATIE                */
/* ----------------------------- */
document.getElementById("to-step-0-next").addEventListener("click", () => {
  const choice = document.querySelector('input[name="calc-type"]:checked');
  if (!choice) {
    alert("Selecteer eerst een berekeningstype.");
    return;
  }
  if (choice.value === "snelle") {
    alert("Snelle berekening komt later beschikbaar. Gebruik nu de nauwkeurige CSV-berekening.");
    return;
  }
  activateStep(1);
});

document.getElementById("to-step-2").addEventListener("click", () => activateStep(2));
document.getElementById("back-to-1").addEventListener("click", () => activateStep(1));
document.getElementById("to-step-3").addEventListener("click", () => activateStep(3));
document.getElementById("back-to-2").addEventListener("click", () => activateStep(2));

// ‚úÖ Nieuw: navigatie voor stap 5 (advies)
document.getElementById("to-step-5").addEventListener("click", () => {
  if (!window.computedResult) {
    alert("Voer eerst een berekening uit bij stap 4.");
    return;
  }
  activateStep(5);
});

document.getElementById("back-to-4").addEventListener("click", () => activateStep(4));

/* ----------------------------- */
/*      COMPUTE                 */
/* ----------------------------- */
document.getElementById("btn-compute").addEventListener("click", async () => {
  const status = document.getElementById("compute-status");
  status.textContent = "Berekenen‚Ä¶";
  status.className = "status";

  alert("CLICK OP BEREKEN WORDT UITGEVOERD");

  if (!parsedData.load_kwh) {
    status.textContent = "CSV-data ontbreekt. Verwerk eerst CSV in stap 1.";
    status.className = "status error";
    return;
  }

  // ===============================
  // Batterij-investering (veilig)
  // ===============================
  const batteryCostRaw = document.getElementById("battery-cost").value || "";
  const cleanedBatteryCost = batteryCostRaw
    .replace("‚Ç¨", "")
    .replace(",", ".")
    .replace(/\s+/g, "");

  const batteryCost = parseFloat(cleanedBatteryCost);

  if (!cleanedBatteryCost || isNaN(batteryCost) || batteryCost <= 0) {
    status.textContent = "Voer een geldige batterij-investering in.";
    status.className = "status error";
    return;
  }

  // ===============================
  // üîß Omvormerkosten
  // UI = ‚Ç¨/kW per maand
  // ===============================
  
  // üîß Omvormerkosten (veilig ‚Äî voorkomt 422)
  const inverterPower =
    parseFloat(document.getElementById("P").value || "0");

  const inverterCostPerKwMonth =
    parseFloat(document.getElementById("tlv_per_kw_inverter").value || "0");

  // ===============================
  // REQUEST BODY
  // ===============================
  const body = {
    // Profielen
    load_kwh: parsedData.load_kwh,
    pv_kwh: parsedData.pv_kwh,
    prices_dyn: parsedData.prices_dyn || [],

    // Tarieven
    p_enkel_imp: parseFloat(document.getElementById("p_enkel_imp").value || "0.29"),
    p_enkel_exp: parseFloat(document.getElementById("p_enkel_exp").value || "0.07"),

    p_dag: parseFloat(document.getElementById("p_dag").value || "0.31"),
    p_nacht: parseFloat(document.getElementById("p_nacht").value || "0.26"),
    p_exp_dn: parseFloat(document.getElementById("p_exp_dn").value || "0.07"),

    p_export_dyn: parseFloat(document.getElementById("p_export_dyn").value || "0.07"),

    // Terugleverkosten
    feedin_monthly_cost: parseFloat(document.getElementById("tlv_monthly_fee").value || "0"),
    feedin_cost_per_kwh: parseFloat(document.getElementById("tlv_per_kwh").value || "0"),
    feedin_free_kwh: parseFloat(document.getElementById("tlv_free_kwh").value || "0"),
    feedin_price_after_free: parseFloat(document.getElementById("tlv_per_kwh").value || "0"),

    // üîß Omvormer
    inverter_power_kw: inverterPower,

    // Alleen kosten meesturen als P > 0
    inverter_cost_per_kw_month:
      inverterPower > 0 ? inverterCostPerKwMonth : 0,

    inverter_cost_per_kw:
      inverterPower > 0 ? inverterCostPerKwMonth * 12 : 0,

    // Batterij
    E: parseFloat(document.getElementById("E").value || "0"),
    P: parseFloat(document.getElementById("P").value || "0"),
    DoD: parseFloat(document.getElementById("DoD").value || "0") / 100,
    eta_rt: parseFloat(document.getElementById("eta_rt").value || "0") / 100,

    // Vastrecht (‚Ç¨/jaar)
    vastrecht_year: parseFloat(document.getElementById("fixed-cost").value || "0"),

    // Investering & degradatie
    battery_cost: batteryCost,
    battery_degradation:
      parseFloat(document.getElementById("battery-degradation").value || "2") / 100,
    battery_lifetime_years:
      parseInt(document.getElementById("battery-lifetime").value || "15"),

    // Capaciteitstarief (BE)
    capacity_tariff_kw:
      parseFloat(document.getElementById("capacity-tariff").value || "0"),

    // Context
    country: document.getElementById("country").value || "NL",
    current_tariff: document.getElementById("tariff-type").value || "enkel"
  };

  try {
    const res = await fetch(API_BASE + "/compute_v3", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    const data = await res.json();

// ‚úÖ Controleer op juiste backend-velden
if (
  !data ||
  typeof data.A1_current !== "number" ||
  typeof data.B1_future_no_batt !== "number" ||
  typeof data.C1_future_with_batt !== "number"
) {
  console.error("Backend response:", data);
  status.textContent = "Onvolledig antwoord van de server.";
  status.className = "status error";
  return;
}

    window.computedResult = data;

    status.textContent = "Berekening afgerond.";
    status.className = "status success";
    activateStep(4);
    fillResults(data);
    updateCostChart(data);

  } catch (err) {
    status.textContent = "Fout: " + err.message;
    status.className = "status error";
  }
});

  function fillResults(data) {
    // KPI's bovenin
    document.getElementById("res-A1").textContent =
      fmtEuro(data.A1_current);

    document.getElementById("res-B1").textContent =
      fmtEuro(data.B1_future_no_batt);

    document.getElementById("res-C1").textContent =
      fmtEuro(data.C1_future_with_batt);

    document.getElementById("res-savings").textContent =
      fmtEuro(data.besparing_per_jaar);

    document.getElementById("res-payback").textContent =
      (data.payback_years && isFinite(data.payback_years))
        ? data.payback_years.toFixed(1) + " jaar"
        : "‚Äì";

    document.getElementById("res-roi").textContent =
      (data.roi_percent && isFinite(data.roi_percent))
        ? data.roi_percent.toFixed(1) + " %"
        : "‚Äì";
  }
  
/* ----------------------------- */
/*   ADVIES GENEREREN (STEP 5)  */
/* ----------------------------- */
function buildAdviceText(data) {
  const country = (document.getElementById("country")?.value || "NL").toUpperCase();

  const E   = parseFloat(document.getElementById("E").value || "0");
  const P   = parseFloat(document.getElementById("P").value || "0");
  const DoD = parseFloat(document.getElementById("DoD").value || "0");
  const eta = parseFloat(document.getElementById("eta_rt").value || "0");
  const capTariff = parseFloat(document.getElementById("capacity-tariff").value || "0");
  const battCost  = parseFloat(document.getElementById("battery-cost").value || "0");
  const degr      = parseFloat(document.getElementById("battery-degradation").value || "0");
  const tariffType = document.getElementById("tariff-type").value || "enkel";

  const A1   = data.A1;
  const B1   = data.B1;
  const C1   = data.C1;
  const save = data.besparing_per_jaar || 0;
  const roi  = data.roi_percent || 0;
  const pb   = data.payback_years || null;

  // Jaarverbruik uit CSV (als beschikbaar)
  let annualLoad = 0;
  if (parsedData && Array.isArray(parsedData.load_kwh)) {
    annualLoad = parsedData.load_kwh.reduce((a, b) => a + b, 0);
  }

  let lines = [];

  // 1. Samenvatting
  lines.push("1. Samenvatting");
  lines.push(
    `Uw huidige jaarlijkse kosten (scenario A1) bedragen ongeveer ‚Ç¨ ${Number(A1).toFixed(2)}. ` +
    `In de toekomstige situatie zonder batterij (B1) komt dit uit op circa ‚Ç¨ ${Number(B1).toFixed(2)}, ` +
    `terwijl met de gekozen thuisbatterij (C1) de kosten dalen naar ongeveer ‚Ç¨ ${Number(C1).toFixed(2)} per jaar.`
  );

  if (save > 0) {
    lines.push(
      `De geschatte jaarlijkse besparing door de batterij bedraagt ongeveer ‚Ç¨ ${save.toFixed(2)}.`
    );
  } else {
    lines.push(
      `Op basis van de ingevoerde gegevens lijkt de batterij momenteel geen directe jaarlijkse besparing op te leveren.`
    );
  }

  // 2. Financi√´le analyse
  lines.push("");
  lines.push("2. Financi√´le analyse");
  lines.push(
    `De totale investering in de batterij bedraagt circa ‚Ç¨ ${battCost.toFixed(0)}.`
  );

  if (pb && isFinite(pb)) {
    lines.push(
      `Op basis van de simulatie wordt de investering naar verwachting in ongeveer ${pb.toFixed(1)} jaar terugverdiend.`
    );
  } else if (roi > 0) {
    lines.push(
      `Binnen de beschouwde periode wordt de investering niet volledig terugverdiend, maar de ROI blijft positief (${roi.toFixed(1)}%).`
    );
  } else {
    lines.push(
      `De huidige combinatie van stroomprijzen, verbruik en batterijgrootte leidt niet tot een sluitende businesscase binnen de simulatiehorizon.`
    );
  }

  if (roi > 0) {
    lines.push(
      `De geschatte Return on Investment (ROI) over de levensduur van de batterij bedraagt ongeveer ${roi.toFixed(1)}%.`
    );
  }

  // 3. Technische beoordeling
  lines.push("");
  lines.push("3. Technische beoordeling");
  lines.push(
    `De gekozen batterij heeft een opslagcapaciteit (E) van ${E.toFixed(1)} kWh en een laad/ontlaadvermogen (P) van ${P.toFixed(1)} kW. `
    + `De diepte van ontlading (DoD) is ingesteld op ${DoD.toFixed(0)}% en de round-trip effici√´ntie op ${eta.toFixed(0)}%.`
  );

  if (annualLoad > 0) {
    lines.push(
      `Op basis van de aangeleverde meetdata bedraagt uw jaarlijkse elektriciteitsverbruik ongeveer ${annualLoad.toFixed(0)} kWh. `
      + `Daarmee vertegenwoordigt de batterij circa ${(100 * E / annualLoad).toFixed(1)}% van uw jaarverbruik per volledige lading.`
    );
  }

  // 4. Specifiek advies per land
  lines.push("");
  lines.push("4. Land-specifiek advies");

  if (country === "BE") {
    lines.push(
      "U heeft aangegeven dat de installatie zich in Belgi√´ bevindt. In Belgi√´ speelt het capaciteitstarief een belangrijke rol " +
      "in de totale energiekost. De batterij wordt in deze simulatie ingezet voor peak-shaving: het verlagen van maandelijkse piekvermogens."
    );

    lines.push(
      `Met een capaciteitstarief van ongeveer ‚Ç¨ ${capTariff.toFixed(2)} per kW per jaar kan het verlagen van uw maandpieken ` +
      "een significante bijdrage leveren aan de totale besparing."
    );
  } else {
    lines.push(
      "U heeft aangegeven dat de installatie zich in Nederland bevindt. In Nederland is er op dit moment geen officieel capaciteitstarief " +
      "voor particuliere aansluitingen, waardoor de financi√´le waarde van de batterij vooral wordt bepaald door:"
    );
    lines.push(
      "- het verhogen van het eigen verbruik van uw zonnepanelen;\n" +
      "- het vermijden van teruglevering tegen lagere vergoeding;\n" +
      "- en eventuele dynamische energiecontracten waarbij u slim kunt laden bij lage prijzen."
    );
  }

  // 5. Aanbevolen vervolgstappen
  lines.push("");
  lines.push("5. Aanbevolen vervolgstappen");

  if (save > 0 && pb && pb < 10) {
    lines.push(
      "De berekende besparing en terugverdientijd zijn aantrekkelijk. Het verdient aanbeveling om offertes op te vragen voor " +
      "een batterij in deze orde van grootte en de resultaten te vergelijken met de werkelijke conditities van uw energieleverancier."
    );
  } else if (save > 0) {
    lines.push(
      "De batterij levert een besparing op, maar de terugverdientijd is relatief lang. Mogelijk is een kleinere batterijcapaciteit of een " +
      "andere configuratie (bijv. ander vermogen of ander tarief) financieel gunstiger."
    );
  } else {
    lines.push(
      "Op basis van de huidige parameters lijkt een thuisbatterij financieel minder interessant. U kunt overwegen om de parameters opnieuw te " +
      "doorlopen (batterijgrootte, investering, tarieven) of te wachten op gewijzigde marktcondities (bijvoorbeeld hogere terugleverboetes of " +
      "grotere prijsverschillen op dynamische contracten)."
    );
  }

  lines.push("");
  lines.push(
    "Dit advies is gebaseerd op de door u aangeleverde meetdata en parameters. In de praktijk kunnen contractvoorwaarden, netwerkkosten en " +
    "toekomstige wetswijzigingen de resultaten be√Ønvloeden."
  );

  return lines.join("\n\n");
}

// Klik op ‚ÄúGenereer advies‚Äù
document.getElementById("btn-generate-advice").addEventListener("click", () => {
  const statusEl = document.getElementById("advice-status");
  const textEl   = document.getElementById("advice-text");

  if (!window.computedResult) {
    alert("Voer eerst een berekening uit (stap 3 en 4).");
    return;
  }

  statusEl.textContent = "Advies wordt opgebouwd op basis van uw berekende scenario‚Äôs‚Ä¶";

  const txt = buildAdviceText(window.computedResult);

  // ‚úÖ bewaar advies ook in een globale variabele
  window.computedAdvice = txt;

  // Toon in de textarea
  textEl.value = txt;

  statusEl.textContent = "Advies gegenereerd. U kunt deze tekst nu kopi√´ren of aanpassen.";
});

/* PDF EXPORT */
document.getElementById("btn-download-pdf").addEventListener("click", () => {
  if (!window.computedResult) {
    alert("Geen berekening beschikbaar. Voer eerst een berekening uit.");
    return;
  }
  pdfExport(window.computedResult);
});

  /* ========================================================= */
  /*        GRAFIEK ‚Äî KOSTEN & RENDEMENT OVER LEVENSDUUR       */
  /* ========================================================= */
  function updateCostChart(result) {
    const ctx = document.getElementById("chart").getContext("2d");

    // Oude grafiek opruimen
    if (costChart) {
      costChart.destroy();
    }

    const lifetime =
      parseInt(document.getElementById("battery-lifetime").value || "15");

    const investment =
      parseFloat(document.getElementById("battery-cost").value || "0");

    const yearlySaving = result.besparing_per_jaar || 0;

    // Kosten zonder batterij (B1) en met batterij (C1)
    const costWithoutBatt = result.B1_future_no_batt;
    const costWithBatt    = result.C1_future_with_batt;

    let labels = [];
    let withoutBatt = [];
    let withBatt = [];
    let cumulative = [];

    let cum = -investment;

    for (let year = 0; year <= lifetime; year++) {
      labels.push("Jaar " + year);

      if (year === 0) {
        withoutBatt.push(0);
        withBatt.push(-investment);
        cumulative.push(-investment);
      } else {
        withoutBatt.push(costWithoutBatt);
        withBatt.push(costWithBatt);
        cum += yearlySaving;
        cumulative.push(cum);
      }
    }

    costChart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: "Kosten zonder batterij",
            data: withoutBatt,
            borderWidth: 2,
            tension: 0.25
          },
          {
            label: "Kosten met batterij",
            data: withBatt,
            borderWidth: 2,
            tension: 0.25
          },
          {
            label: "Cumulatieve besparing",
            data: cumulative,
            borderWidth: 3,
            borderDash: [6, 6],
            tension: 0.25
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: "bottom"
          },
          tooltip: {
            callbacks: {
              label: (ctx) => "‚Ç¨ " + ctx.parsed.y.toFixed(0)
            }
          }
        },
        scales: {
          y: {
            ticks: {
              callback: (v) => "‚Ç¨ " + v
            }
          }
        }
      }
    });
  }
  
/* DEFAULTS */
window.addEventListener("DOMContentLoaded", () => {
  activateStep(0);
  updatePricesVisibility();
  updateCountryUI();

  document.getElementById("p_enkel_imp").value = "0.29";
  document.getElementById("p_enkel_exp").value = "0.07";

  document.getElementById("p_dag").value    = "0.31";
  document.getElementById("p_nacht").value  = "0.26";
  document.getElementById("p_exp_dn").value = "0.07";

  document.getElementById("p_export_dyn").value = "0.07";
});
</script>
</body>
</html>
