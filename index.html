<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Thuisbatterij Besparingscalculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- ======================= -->
  <!--        STYLING          -->
  <!-- ======================= -->
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --bg: #f5f7fa;
      --card-bg: #ffffff;
      --text: #1e293b;
      --muted: #64748b;
      --border: #e2e8f0;
      --danger: #dc2626;
      --success: #15803d;
      --highlight: #dbeafe;
    }

    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #f5f7fa;
      color: var(--text);
    }

    .page { max-width: 1200px; margin: 0 auto; padding: 32px 18px 60px; }
    .title { font-size: 2rem; font-weight: 700; }
    .subtitle { margin-top: 4px; font-size: 1rem; color: var(--muted); }

    /* STEPPER */
    .stepper { display:flex; gap:10px; margin:24px 0; flex-wrap:wrap; }
    .step {
      display:flex; align-items:center; gap:8px;
      padding:7px 14px; border-radius:999px;
      background:#fff; border:1px solid var(--border);
      font-size:0.85rem; color:var(--muted);
    }
    .step.active {
      background:var(--highlight);
      border-color:var(--primary);
      color:var(--primary-dark);
      font-weight:600;
    }
    .badge {
      width:22px; height:22px; border-radius:999px; border:1px solid currentColor;
      display:flex; align-items:center; justify-content:center; font-size:0.8rem;
    }

    .layout { display:grid; grid-template-columns:minmax(0,3fr) minmax(0,2fr); gap:24px; }
    @media(max-width:900px) { .layout { grid-template-columns:1fr; } }

    .card {
      background:var(--card-bg); border-radius:16px; padding:24px;
      border:1px solid var(--border); box-shadow:0 24px 60px rgba(0,0,0,0.04);
    }

    .field { margin-bottom:16px; }
    .field label { display:block; margin-bottom:7px; font-weight:600; }
    input, select {
      width:100%; padding:10px 12px; border-radius:8px;
      border:1px solid var(--border); font-size:0.9rem; background:#fafbfc;
    }

    button { border:none; border-radius:8px; padding:10px 18px; font-size:0.9rem; cursor:pointer; }
    .btn-primary { background:var(--primary); color:white; }
    .btn-secondary { background:#e2e8f0; color:#1e293b; }

    table { width:100%; border-collapse:collapse; margin-top:14px; font-size:0.85rem; }
    th,td { border:1px solid var(--border); padding:8px 10px; text-align:right; }
    th:first-child, td:first-child { text-align:left; }
    th { background:#f1f5f9; font-weight:600; }

    td.highlight { background:var(--highlight); font-weight:700; }

    #chart { margin-top:20px; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
<div class="page">

<header>
  <div class="title">Thuisbatterij Besparingscalculator</div>
  <div class="subtitle">Nauwkeurige berekening met CSV-data en volledig adviesrapport.</div>
</header>

<!-- ======================= -->
<!--        STEPPER          -->
<!-- ======================= -->
<div class="stepper">
  <div class="step active" id="step-pill-0"><div class="badge">0</div> Start</div>
  <div class="step" id="step-pill-1"><div class="badge">1</div> CSV & Tarief</div>
  <div class="step" id="step-pill-2"><div class="badge">2</div> Batterij</div>
  <div class="step" id="step-pill-3"><div class="badge">3</div> Tarieven</div>
  <div class="step" id="step-pill-4"><div class="badge">4</div> Resultaat</div>
</div>

<div class="layout">
<div class="card" id="wizard-container">

<!-- ======================= -->
<!--        STEP 0           -->
<!-- ======================= -->
<div id="step-0">
  <h2>Stap 0 Â· Kies uw berekeningstype</h2>

  <label><input type="radio" name="calc-type" value="snelle"> Snelle berekening</label><br>
  <label><input type="radio" name="calc-type" value="nauwkeurige"> Nauwkeurige CSV-berekening</label><br>

  <button class="btn-primary" id="to-step-0-next">Volgende</button>
</div>

<!-- ======================= -->
<!--        STEP 1           -->
<!-- ======================= -->
<div id="step-1" style="display:none;">
  <h2>Stap 1 Â· Tarief & CSV-bestanden</h2>

  <div class="field">
    <label>Huidig tarief</label>
    <select id="tariff-type">
      <option value="enkel">Enkel</option>
      <option value="dag_nacht">Dag/Nacht</option>
      <option value="dynamisch">Dynamisch</option>
    </select>
  </div>

  <div class="field"><label>load.csv</label><input type="file" id="file-load"></div>
  <div class="field"><label>pv.csv</label><input type="file" id="file-pv"></div>
  <div class="field"><label>prices.csv (dynamisch)</label><input type="file" id="file-prices"></div>

  <div id="csv-status" class="status">Nog geen CSV verwerkt.</div>

  <button class="btn-primary" id="btn-parse-csv">CSV verwerken</button>
  <button class="btn-primary" id="to-step-2" disabled>Volgende</button>
</div>

<!-- ======================= -->
<!--        STEP 2           -->
<!-- ======================= -->
<div id="step-2" style="display:none;">
  <h2>Stap 2 Â· Batterij</h2>

  <div class="field"><label>E (kWh)</label><input id="E" type="number"></div>
  <div class="field"><label>P (kW)</label><input id="P" type="number"></div>
  <div class="field"><label>DoD (%)</label><input id="DoD" type="number"></div>
  <div class="field"><label>Î·_rt (%)</label><input id="eta_rt" type="number"></div>
  <div class="field"><label>Vastrecht (â‚¬/jaar)</label><input id="fixed-cost" type="number"></div>

  <button class="btn-secondary" id="back-to-1">Vorige</button>
  <button class="btn-primary" id="to-step-3">Volgende</button>
</div>

<!-- ======================= -->
<!--        STEP 3           -->
<!-- ======================= -->
<div id="step-3" style="display:none;">
  <h2>Stap 3 Â· Tarieven</h2>

  <h3>Enkel tarief</h3>
  <div class="field"><label>Import</label><input id="p_enkel_imp"></div>
  <div class="field"><label>Export</label><input id="p_enkel_exp"></div>

  <h3>Dag/Nacht</h3>
  <div class="field"><label>Dag</label><input id="p_dag"></div>
  <div class="field"><label>Nacht</label><input id="p_nacht"></div>
  <div class="field"><label>Export</label><input id="p_exp_dn"></div>

  <h3>Dynamisch tarief</h3>
  <div class="field"><label>Exportprijs</label><input id="p_export_dyn"></div>

  <div id="compute-status" class="status"></div>

  <button class="btn-secondary" id="back-to-2">Vorige</button>
  <button class="btn-primary" id="btn-compute">Bereken</button>
</div>

<!-- ======================= -->
<!--        STEP 4           -->
<!-- ======================= -->
<div id="step-4" style="display:none;">
  <h2>Resultaten</h2>

  <div class="results-summary">
    <div class="result-tile"><div class="label">Huidige situatie (A1)</div><div class="value" id="res-A1">â€“</div></div>
    <div class="result-tile"><div class="label">Zonder batterij (B1)</div><div class="value" id="res-B1">â€“</div></div>
    <div class="result-tile"><div class="label">Met batterij (C1)</div><div class="value" id="res-C1">â€“</div></div>
  </div>

  <h3>Tariefmatrix</h3>
  <table>
    <tr><th>Scenario</th><th>Enkel</th><th>Dag/Nacht</th><th>Dynamisch</th></tr>

    <tr><td>Huidige situatie</td><td id="A1-enkel">â€“</td><td id="A1-dn">â€“</td><td id="A1-dyn">â€“</td></tr>
    <tr><td>Zonder batterij</td><td id="B1-enkel">â€“</td><td id="B1-dn">â€“</td><td id="B1-dyn">â€“</td></tr>
    <tr><td>Met batterij</td><td id="C1-enkel">â€“</td><td id="C1-dn">â€“</td><td id="C1-dyn">â€“</td></tr>
  </table>

  <h3>Energie-inzichten</h3>
  <table>
    <tr><th></th><th>Enkel</th><th>Dag/Nacht</th><th>Dynamisch</th></tr>

    <tr><td>B1 Import</td><td id="B1-imp-enkel">â€“</td><td id="B1-imp-dn">â€“</td><td id="B1-imp-dyn">â€“</td></tr>
    <tr><td>B1 Export</td><td id="B1-exp-enkel">â€“</td><td id="B1-exp-dn">â€“</td><td id="B1-exp-dyn">â€“</td></tr>

    <tr><td>C1 Import</td><td id="C1-imp-enkel">â€“</td><td id="C1-imp-dn">â€“</td><td id="C1-imp-dyn">â€“</td></tr>
    <tr><td>C1 Export</td><td id="C1-exp-enkel">â€“</td><td id="C1-exp-dn">â€“</td><td id="C1-exp-dyn">â€“</td></tr>
  </table>

  <button class="btn-primary" id="btn-download-pdf">ðŸ“„ Download PDF</button>
</div>

</div>

<!-- ======================= -->
<!-- GRAFIEK (rechterkolom) -->
<!-- ======================= -->
<div class="card">
  <h2>Grafiek â€” Jaarlijkse kosten</h2>
  <canvas id="chart" height="140"></canvas>
</div>

</div> <!-- /layout -->
</div> <!-- /page -->

<!-- ======================= -->
<!--     SCRIPTS BEGINT      -->
<!-- ======================= -->
<script>
const API_BASE = "https://batteryengine-server.onrender.com";
let parsedData = {};

function activateStep(n) {
  for (let i = 0; i < 5; i++) {
    document.getElementById("step-pill-" + i).classList.toggle("active", i === n);
    document.getElementById("step-" + i).style.display = (i === n) ? "block" : "none";
  }
}

function fmtEuro(x) { return "â‚¬ " + x.toFixed(2).replace(".", ","); }

/* CSV PROCESSING */
document.getElementById("btn-parse-csv").addEventListener("click", async () => {
  const loadFile = file-load.files[0];
  const pvFile = file-pv.files[0];
  const pricesFile = file-prices.files[0];
  const status = csv-status;

  if (!loadFile || !pvFile || !pricesFile) {
    status.textContent = "Alle 3 CSV-bestanden zijn nodig.";
    status.className = "status error";
    return;
  }

  status.textContent = "Verwerkenâ€¦";

  const [loadText, pvText, pricesText] = await Promise.all([
    loadFile.text(), pvFile.text(), pricesFile.text()
  ]);

  const res = await fetch(API_BASE + "/parse_csv", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      load_file: loadText,
      pv_file: pvText,
      prices_file: pricesText
    })
  });

  const data = await res.json();
  if (data.error) {
    status.textContent = "Fout in CSV.";
    status.className = "status error";
    return;
  }

  parsedData = data;
  status.textContent = "CSV verwerkt âœ”";
  status.className = "status success";
  to-step-2.disabled = false;
});

/* NAVIGATIE */
to-step-0-next.addEventListener("click", () => {
  const choice = document.querySelector('input[name="calc-type"]:checked');
  if (!choice) return alert("Selecteer een optie.");
  activateStep(1);
});
to-step-2.addEventListener("click", ()=>activateStep(2));
back-to-1.addEventListener("click", ()=>activateStep(1));
to-step-3.addEventListener("click", ()=>activateStep(3));
back-to-2.addEventListener("click", ()=>activateStep(2));

/* COMPUTE */
btn-compute.addEventListener("click", async () => {
  compute-status.textContent = "Berekenenâ€¦";

  const body = {
    load_kwh: parsedData.load_kwh,
    pv_kwh: parsedData.pv_kwh,
    prices_dyn: parsedData.prices_dyn,

    p_enkel_imp: parseFloat(p_enkel_imp.value),
    p_enkel_exp: parseFloat(p_enkel_exp.value),

    p_dag: parseFloat(p_dag.value),
    p_nacht: parseFloat(p_nacht.value),
    p_exp_dn: parseFloat(p_exp_dn.value),

    p_export_dyn: parseFloat(p_export_dyn.value),

    E: parseFloat(E.value),
    P: parseFloat(P.value),
    DoD: parseFloat(DoD.value) / 100,
    eta_rt: parseFloat(eta_rt.value) / 100,

    Vastrecht: parseFloat(fixed-cost.value),
    current_tariff: tariff-type.value
  };

  const res = await fetch(API_BASE + "/compute", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(body)
  });

  const data = await res.json();
  window.computedResult = data;

  /* Tegels */
  res-A1.textContent = fmtEuro(data.A1_current);
  res-B1.textContent = fmtEuro(data.B1_future_no_batt);
  res-C1.textContent = fmtEuro(data.C1_future_with_batt);

  /* Tariefmatrix */
  A1-enkel.textContent = fmtEuro(data.A1_per_tariff.enkel);
  A1-dn.textContent    = fmtEuro(data.A1_per_tariff.dag_nacht);
  A1-dyn.textContent   = fmtEuro(data.A1_per_tariff.dynamisch);

  B1-enkel.textContent = fmtEuro(data.S2_enkel.total_cost);
  B1-dn.textContent    = fmtEuro(data.S2_dn.total_cost);
  B1-dyn.textContent   = fmtEuro(data.S2_dyn.total_cost);

  C1-enkel.textContent = fmtEuro(data.S3_enkel.total_cost);
  C1-dn.textContent    = fmtEuro(data.S3_dn.total_cost);
  C1-dyn.textContent   = fmtEuro(data.S3_dyn.total_cost);

  /* Energie-inzichten */
  B1-imp-enkel.textContent = data.S2_enkel.import.toFixed(1);
  B1-imp-dn.textContent    = data.S2_dn.import.toFixed(1);
  B1-imp-dyn.textContent   = data.S2_dyn.import.toFixed(1);

  B1-exp-enkel.textContent = data.S2_enkel.export.toFixed(1);
  B1-exp-dn.textContent    = data.S2_dn.export.toFixed(1);
  B1-exp-dyn.textContent   = data.S2_dyn.export.toFixed(1);

  C1-imp-enkel.textContent = data.S3_enkel.import.toFixed(1);
  C1-imp-dn.textContent    = data.S3_dn.import.toFixed(1);
  C1-imp-dyn.textContent   = data.S3_dyn.import.toFixed(1);

  C1-exp-enkel.textContent = data.S3_enkel.export.toFixed(1);
  C1-exp-dn.textContent    = data.S3_dn.export.toFixed(1);
  C1-exp-dyn.textContent   = data.S3_dyn.export.toFixed(1);

  /* Chart.js */
  if (window.costChart) window.costChart.destroy();
  window.costChart = new Chart(chart.getContext("2d"), {
    type:"bar",
    data:{
      labels:["A1", "B1", "C1"],
      datasets:[{
        label:"Jaarlijkse kosten (â‚¬)",
        data:[data.A1_current, data.B1_future_no_batt, data.C1_future_with_batt]
      }]
    }
  });

  compute-status.textContent = "Klaar.";
  compute-status.className = "status success";
  activateStep(4);
});

/* ======================= */
/*     PDF EXPORT          */
/* ======================= */
function pdfExport(data) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"a4" });

  doc.setFont("helvetica", "bold");
  doc.setFontSize(22);
  doc.text("Thuisbatterij Adviesrapport", 40, 60);

  doc.setFontSize(14);
  doc.text("Tarievenmatrix", 40, 110);

  // Simple stable table
  const rows = [
    ["Scenario", "Enkel", "Dag/Nacht", "Dynamisch"],
    ["Huidige situatie", 
      fmtEuro(data.A1_per_tariff.enkel),
      fmtEuro(data.A1_per_tariff.dag_nacht),
      fmtEuro(data.A1_per_tariff.dynamisch)
    ],
    ["Zonder batterij",
      fmtEuro(data.S2_enkel.total_cost),
      fmtEuro(data.S2_dn.total_cost),
      fmtEuro(data.S2_dyn.total_cost)
    ],
    ["Met batterij",
      fmtEuro(data.S3_enkel.total_cost),
      fmtEuro(data.S3_dn.total_cost),
      fmtEuro(data.S3_dyn.total_cost)
    ]
  ];

  let y = 140;
  rows.forEach(r=>{
    doc.text(r[0], 40, y);
    doc.text(r[1], 220, y);
    doc.text(r[2], 350, y);
    doc.text(r[3], 480, y);
    y += 20;
  });

  doc.addPage();
  doc.setFontSize(14);
  doc.text("Energie-inzichten (kWh)", 40, 60);
  y = 90;

  const rows2 = [
    ["", "Enkel", "Dag/Nacht", "Dynamisch"],
    ["B1 Import", data.S2_enkel.import.toFixed(1), data.S2_dn.import.toFixed(1), data.S2_dyn.import.toFixed(1)],
    ["B1 Export", data.S2_enkel.export.toFixed(1), data.S2_dn.export.toFixed(1), data.S2_dyn.export.toFixed(1)],
    ["C1 Import", data.S3_enkel.import.toFixed(1), data.S3_dn.import.toFixed(1), data.S3_dyn.import.toFixed(1)],
    ["C1 Export", data.S3_enkel.export.toFixed(1), data.S3_dn.export.toFixed(1), data.S3_dyn.export.toFixed(1)]
  ];
  rows2.forEach(r=>{
    doc.text(r[0], 40, y);
    doc.text(r[1], 220, y);
    doc.text(r[2], 350, y);
    doc.text(r[3], 480, y);
    y += 20;
  });

  doc.save("Thuisbatterij-adviesrapport.pdf");
}

document.getElementById("btn-download-pdf").addEventListener("click", () => {
  pdfExport(window.computedResult);
});

/* Defaults */
window.addEventListener("DOMContentLoaded", () => {
  activateStep(0);
  p_enkel_imp.value = "0.29";
  p_enkel_exp.value = "0.07";

  p_dag.value       = "0.31";
  p_nacht.value     = "0.26";
  p_exp_dn.value    = "0.07";

  p_export_dyn.value = "0.07";
});
</script>

</body>
</html>
