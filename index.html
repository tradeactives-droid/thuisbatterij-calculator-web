<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Thuisbatterij Besparingscalculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- ======================= -->
  <!--        STYLING          -->
  <!-- ======================= -->
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --bg: #f5f7fa;
      --card-bg: #ffffff;
      --text: #1e293b;
      --muted: #64748b;
      --border: #e2e8f0;
      --danger: #dc2626;
      --success: #15803d;
      --highlight: #dbeafe;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #f5f7fa;
      color: var(--text);
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 18px 60px;
    }

    .title { font-size: 2rem; font-weight: 700; }
    .subtitle { margin-top: 4px; font-size: 1rem; color: var(--muted); }

    /* STEPPER */
    .stepper { display:flex; gap:10px; margin:24px 0; flex-wrap:wrap; }
    .step {
      display:flex; align-items:center; gap:8px;
      padding:7px 14px; border-radius:999px;
      background:#fff; border:1px solid var(--border);
      font-size:0.85rem; color:var(--muted);
    }
    .step.active {
      background:var(--highlight);
      border-color:var(--primary);
      color:var(--primary-dark);
      font-weight:600;
    }
    .badge {
      width:22px; height:22px; border-radius:999px; border:1px solid currentColor;
      display:flex; align-items:center; justify-content:center; font-size:0.8rem;
    }

    .layout {
      display:grid;
      grid-template-columns:minmax(0,3fr) minmax(0,2fr);
      gap:24px;
    }
    @media(max-width:900px) {
      .layout { grid-template-columns:1fr; }
    }

    .card {
      background:var(--card-bg);
      border-radius:16px;
      padding:24px;
      border:1px solid var(--border);
      box-shadow:0 24px 60px rgba(0,0,0,0.04);
    }

    h2 { margin-top:0; margin-bottom:18px; font-size:1.4rem; }

    .field { margin-bottom:16px; }
    .field label { display:block; margin-bottom:7px; font-weight:600; }

    /* RADIO-OPTIES IN STAP 0 */
.choice-row {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 6px 0;
  font-size: 0.95rem;
  cursor: pointer;
}

.choice-row input[type="radio"] {
  width: 18px;
  height: 18px;
}

.choice-row span {
  flex: 1;
}

    /* RADIO-OPTIES IN STAP 0 */
.choice-row {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 6px 0;
  font-size: 0.95rem;
  cursor: pointer;
}

.choice-row input[type="radio"] {
  width: 18px;
  height: 18px;
}

.choice-row span {
  flex: 1;
}

    input, select {
      width:100%;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid var(--border);
      font-size:0.9rem;
      background:#fafbfc;
    }

    input:focus, select:focus {
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 1px #bfdbfe;
      background:#ffffff;
    }

    button {
      border:none;
      border-radius:8px;
      padding:10px 18px;
      font-size:0.9rem;
      cursor:pointer;
    }
    .btn-primary { background:var(--primary); color:white; }
    .btn-secondary { background:#e2e8f0; color:#1e293b; }
    .btn-primary:disabled { opacity:0.5; cursor:not-allowed; }

    .status {
      font-size:0.8rem;
      color:var(--muted);
      margin-top:8px;
    }
    .status.error { color:var(--danger); }
    .status.success { color:var(--success); }

    table {
      width:100%;
      border-collapse:collapse;
      margin-top:14px;
      font-size:0.85rem;
    }
    th,td {
      border:1px solid var(--border);
      padding:8px 10px;
      text-align:right;
    }
    th:first-child, td:first-child { text-align:left; }
    th { background:#f1f5f9; font-weight:600; }
    td.highlight { background:var(--highlight); font-weight:700; }

    .results-summary {
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));
      gap:12px;
      margin-bottom:16px;
    }
    .result-tile {
      border-radius:12px;
      border:1px solid var(--border);
      padding:12px 14px;
      background:#f8fafc;
    }
    .result-tile .label {
      font-size:0.8rem;
      color:var(--muted);
      margin-bottom:4px;
    }
    .result-tile .value {
      font-size:1.1rem;
      font-weight:700;
    }

    #chart { margin-top:20px; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
<div class="page">

  <header>
    <div class="title">Thuisbatterij Besparingscalculator</div>
    <div class="subtitle">Nauwkeurige berekening met CSV-data en professioneel adviesrapport.</div>
  </header>

  <!-- ======================= -->
  <!--        STEPPER          -->
  <!-- ======================= -->
  <div class="stepper">
    <div class="step active" id="step-pill-0"><div class="badge">0</div> Start</div>
    <div class="step" id="step-pill-1"><div class="badge">1</div> CSV & Tarief</div>
    <div class="step" id="step-pill-2"><div class="badge">2</div> Batterij</div>
    <div class="step" id="step-pill-3"><div class="badge">3</div> Tarieven</div>
    <div class="step" id="step-pill-4"><div class="badge">4</div> Resultaat</div>
  </div>

  <div class="layout">
    <!-- ======================= -->
    <!--    LINKERKOLOM WIZARD   -->
    <!-- ======================= -->
    <div class="card" id="wizard-container">

      <!-- STEP 0 -->
<div id="step-0">
  <h2>Stap 0 Â· Kies uw berekeningstype</h2>

  <label class="choice-row">
    <input type="radio" name="calc-type" value="snelle">
    <span>Snelle inschatting (nog niet geactiveerd)</span>
  </label>

  <label class="choice-row">
    <input type="radio" name="calc-type" value="nauwkeurige">
    <span>Nauwkeurige CSV-berekening</span>
  </label>

  <br>
  <button class="btn-primary" id="to-step-0-next">Volgende</button>
</div>

      <!-- STEP 1 -->
      <div id="step-1" style="display:none;">
        <h2>Stap 1 Â· Tarief & CSV-bestanden</h2>

        <div class="field">
          <label>Huidig tarief</label>
          <select id="tariff-type">
            <option value="enkel">Enkel</option>
            <option value="dag_nacht">Dag/Nacht</option>
            <option value="dynamisch">Dynamisch</option>
          </select>
        </div>

        <div class="field">
          <label>load.csv</label>
          <input type="file" id="file-load" accept=".csv">
        </div>
        <div class="field">
          <label>pv.csv</label>
          <input type="file" id="file-pv" accept=".csv">
        </div>
        <div class="field">
          <label>prices.csv (dynamisch tarief)</label>
          <input type="file" id="file-prices" accept=".csv">
        </div>

        <div id="csv-status" class="status">Nog geen CSV verwerkt.</div>

        <br>
        <button class="btn-primary" id="btn-parse-csv">CSV verwerken</button>
        <button class="btn-secondary" id="to-step-2" disabled>Volgende</button>
      </div>

      <!-- STEP 2 -->
      <div id="step-2" style="display:none;">
        <h2>Stap 2 Â· Batterij</h2>

        <div class="field">
          <label>Capaciteit E (kWh)</label>
          <input id="E" type="number" min="0" step="0.1">
        </div>
        <div class="field">
          <label>Vermogen P (kW)</label>
          <input id="P" type="number" min="0" step="0.1">
        </div>
        <div class="field">
          <label>Depth of Discharge DoD (%)</label>
          <input id="DoD" type="number" min="0" max="100">
        </div>
        <div class="field">
          <label>Round-trip efficiÃ«ntie Î·_rt (%)</label>
          <input id="eta_rt" type="number" min="0" max="100">
        </div>
        <div class="field">
          <label>Vastrecht (â‚¬/jaar)</label>
          <input id="fixed-cost" type="number" min="0" step="0.01">
        </div>

        <button class="btn-secondary" id="back-to-1">Vorige</button>
        <button class="btn-primary" id="to-step-3">Volgende</button>
      </div>

      <!-- STEP 3 -->
      <div id="step-3" style="display:none;">
        <h2>Stap 3 Â· Tarieven</h2>

        <h3>Enkel tarief</h3>
        <div class="field">
          <label>Importprijs (â‚¬/kWh)</label>
          <input id="p_enkel_imp" type="number" step="0.01">
        </div>
        <div class="field">
          <label>Exportprijs (â‚¬/kWh)</label>
          <input id="p_enkel_exp" type="number" step="0.01">
        </div>

        <h3>Dag/Nacht tarief</h3>
        <div class="field">
          <label>Dagprijs (â‚¬/kWh)</label>
          <input id="p_dag" type="number" step="0.01">
        </div>
        <div class="field">
          <label>Nachtprijs (â‚¬/kWh)</label>
          <input id="p_nacht" type="number" step="0.01">
        </div>
        <div class="field">
          <label>Exportprijs (â‚¬/kWh)</label>
          <input id="p_exp_dn" type="number" step="0.01">
        </div>

        <h3>Dynamisch tarief</h3>
        <div class="field">
          <label>Exportprijs (â‚¬/kWh)</label>
          <input id="p_export_dyn" type="number" step="0.01">
        </div>

        <div id="compute-status" class="status"></div>

        <button class="btn-secondary" id="back-to-2">Vorige</button>
        <button class="btn-primary" id="btn-compute">Bereken</button>
      </div>

      <!-- STEP 4 -->
      <div id="step-4" style="display:none;">
        <h2>Stap 4 Â· Resultaten</h2>

        <div class="results-summary">
          <div class="result-tile">
            <div class="label">Huidige situatie (A1)</div>
            <div class="value" id="res-A1">â€“</div>
          </div>
          <div class="result-tile">
            <div class="label">Toekomst zonder batterij (B1)</div>
            <div class="value" id="res-B1">â€“</div>
          </div>
          <div class="result-tile">
            <div class="label">Toekomst met batterij (C1)</div>
            <div class="value" id="res-C1">â€“</div>
          </div>
        </div>

        <h3>Tariefmatrix (jaarlijkse kosten)</h3>
        <table>
          <tr>
            <th>Scenario</th>
            <th>Enkel</th>
            <th>Dag/Nacht</th>
            <th>Dynamisch</th>
          </tr>
          <tr>
            <td>Huidige situatie</td>
            <td id="A1-enkel">â€“</td>
            <td id="A1-dn">â€“</td>
            <td id="A1-dyn">â€“</td>
          </tr>
          <tr>
            <td>Toekomst zonder batterij</td>
            <td id="B1-enkel">â€“</td>
            <td id="B1-dn">â€“</td>
            <td id="B1-dyn">â€“</td>
          </tr>
          <tr>
            <td>Toekomst met batterij</td>
            <td id="C1-enkel">â€“</td>
            <td id="C1-dn">â€“</td>
            <td id="C1-dyn">â€“</td>
          </tr>
        </table>

        <h3>Energie-inzichten (kWh)</h3>
        <table>
          <tr>
            <th></th>
            <th>Enkel</th>
            <th>Dag/Nacht</th>
            <th>Dynamisch</th>
          </tr>
          <tr>
            <td>B1 Import</td>
            <td id="B1-imp-enkel">â€“</td>
            <td id="B1-imp-dn">â€“</td>
            <td id="B1-imp-dyn">â€“</td>
          </tr>
          <tr>
            <td>B1 Export</td>
            <td id="B1-exp-enkel">â€“</td>
            <td id="B1-exp-dn">â€“</td>
            <td id="B1-exp-dyn">â€“</td>
          </tr>
          <tr>
            <td>C1 Import</td>
            <td id="C1-imp-enkel">â€“</td>
            <td id="C1-imp-dn">â€“</td>
            <td id="C1-imp-dyn">â€“</td>
          </tr>
          <tr>
            <td>C1 Export</td>
            <td id="C1-exp-enkel">â€“</td>
            <td id="C1-exp-dn">â€“</td>
            <td id="C1-exp-dyn">â€“</td>
          </tr>
        </table>

        <br>
        <button class="btn-primary" id="btn-download-pdf" style="display:none;">
          ðŸ“„ Download PDF
        </button>
      </div>

    </div> <!-- /wizard-container -->

    <!-- ======================= -->
    <!--   GRAFIEK RECHTS        -->
    <!-- ======================= -->
    <div class="card">
      <h2>Grafiek â€” Jaarlijkse kosten</h2>
      <canvas id="chart" height="140"></canvas>
    </div>

  </div> <!-- /layout -->
</div> <!-- /page -->

<!-- ========================================================= -->
<!-- ===================  PDF HELPER FUNCTIES  ================ -->
<!-- ========================================================= -->
<script>
function pdfDrawTable(doc, startX, startY, rows, colWidths) {
  let y = startY;
  const rowHeight = 18;

  doc.setFont("helvetica", "bold");
  for (let i = 0; i < rows[0].length; i++) {
    const offset = colWidths.slice(0, i).reduce((a,b)=>a+b,0);
    doc.text(String(rows[0][i]), startX + offset + 4, y);
  }
  y += rowHeight;

  doc.setFont("helvetica","normal");

  for (let r = 1; r < rows.length; r++) {
    let x = startX;
    for (let c = 0; c < rows[r].length; c++) {
      doc.text(String(rows[r][c]), x + 4, y);
      x += colWidths[c];
    }
    y += rowHeight;
  }

  const totalWidth = colWidths.reduce((a,b)=>a+b,0);
  const totalHeight = rowHeight * rows.length;
  doc.rect(startX, startY - rowHeight, totalWidth, totalHeight);

  return y + 10;
}

function pdfHeader(doc) {
  doc.setFont("helvetica", "bold");
  doc.setFontSize(22);
  doc.text("Thuisbatterij Adviesrapport", 40, 60);

  doc.setFontSize(11);
  doc.setFont("helvetica","normal");
  doc.text("Gegenereerd op: " + new Date().toLocaleDateString("nl-NL"), 40, 82);
}

function pdfIntro(doc) {
  doc.setFont("helvetica","bold");
  doc.setFontSize(16);
  doc.text("1. Inleiding", 40, 120);

  doc.setFont("helvetica","normal");
  doc.setFontSize(12);

  const intro =
    "Dit rapport bevat een volledige financiÃ«le en energetische analyse van uw woning " +
    "onder drie tariefstructuren (Enkel, Dag/Nacht, Dynamisch) en in drie scenarioâ€™s: " +
    "huidige situatie, toekomst zonder thuisbatterij en toekomst met thuisbatterij.";

  const lines = doc.splitTextToSize(intro, 520);
  doc.text(lines, 40, 145);
}

function pdfTariffMatrix(doc) {
  doc.addPage();
  doc.setFont("helvetica","bold");
  doc.setFontSize(16);
  doc.text("2. Tarievenoverzicht", 40, 60);

  const rows = [
    ["Tarief", "Importprijs", "Exportprijs"],
    [
      "Enkel",
      document.getElementById("p_enkel_imp").value + " â‚¬/kWh",
      document.getElementById("p_enkel_exp").value + " â‚¬/kWh"
    ],
    [
      "Dag/Nacht",
      document.getElementById("p_dag").value + " / " +
      document.getElementById("p_nacht").value + " â‚¬/kWh",
      document.getElementById("p_exp_dn").value + " â‚¬/kWh"
    ],
    [
      "Dynamisch",
      "Uit CSV (uurprijzen)",
      document.getElementById("p_export_dyn").value + " â‚¬/kWh"
    ]
  ];

  pdfDrawTable(doc, 40, 100, rows, [160, 180, 180]);
}

function pdfCostMatrix(doc, data) {
  doc.addPage();
  doc.setFont("helvetica","bold");
  doc.setFontSize(16);
  doc.text("3. Kostenmatrix (jaarlijkse kosten)", 40, 60);

  const rows = [
    ["Scenario", "Enkel", "Dag/Nacht", "Dynamisch"],
    ["Huidige situatie",
      fmtEuro(data.A1_per_tariff.enkel),
      fmtEuro(data.A1_per_tariff.dag_nacht),
      fmtEuro(data.A1_per_tariff.dynamisch)
    ],
    ["Toekomst zonder batterij",
      fmtEuro(data.S2_enkel.total_cost),
      fmtEuro(data.S2_dn.total_cost),
      fmtEuro(data.S2_dyn.total_cost)
    ],
    ["Toekomst met batterij",
      fmtEuro(data.S3_enkel.total_cost),
      fmtEuro(data.S3_dn.total_cost),
      fmtEuro(data.S3_dyn.total_cost)
    ]
  ];

  pdfDrawTable(doc, 40, 100, rows, [160, 140, 140, 140]);
}

function pdfEnergyTables(doc, data) {
  doc.addPage();
  doc.setFont("helvetica","bold");
  doc.setFontSize(16);
  doc.text("4. Energie-inzichten (kWh)", 40, 60);

  const imports = [
    ["Scenario", "Enkel", "Dag/Nacht", "Dynamisch"],
    ["B1 Import",
      data.S2_enkel.import.toFixed(1),
      data.S2_dn.import.toFixed(1),
      data.S2_dyn.import.toFixed(1)
    ],
    ["C1 Import",
      data.S3_enkel.import.toFixed(1),
      data.S3_dn.import.toFixed(1),
      data.S3_dyn.import.toFixed(1)
    ]
  ];

  let y = pdfDrawTable(doc, 40, 100, imports, [160, 140, 140, 140]);

  const exports = [
    ["Scenario", "Enkel", "Dag/Nacht", "Dynamisch"],
    ["B1 Export",
      data.S2_enkel.export.toFixed(1),
      data.S2_dn.export.toFixed(1),
      data.S2_dyn.export.toFixed(1)
    ],
    ["C1 Export",
      data.S3_enkel.export.toFixed(1),
      data.S3_dn.export.toFixed(1),
      data.S3_dyn.export.toFixed(1)
    ]
  ];

  pdfDrawTable(doc, 40, y + 20, exports, [160, 140, 140, 140]);
}

function pdfBatteryStats(doc, data) {
  doc.addPage();
  doc.setFont("helvetica","bold");
  doc.setFontSize(16);
  doc.text("5. Batterijprestaties", 40, 60);

  const s3 = data.S3_enkel || {import:0, export:0};

  const E   = parseFloat(document.getElementById("E").value || "0");
  const P   = parseFloat(document.getElementById("P").value || "0");
  const DoD = parseFloat(document.getElementById("DoD").value || "0");
  const eta = parseFloat(document.getElementById("eta_rt").value || "0");

  const rows = [
    ["Parameter", "Waarde"],
    ["Import met batterij (kWh)", s3.import.toFixed(1)],
    ["Export met batterij (kWh)", s3.export.toFixed(1)],
    ["Batterijcapaciteit (kWh)", E || "â€“"],
    ["Vermogen (kW)", P || "â€“"],
    ["Depth of Discharge (%)", DoD || "â€“"],
    ["Round-trip efficiÃ«ntie (%)", eta || "â€“"]
  ];

  pdfDrawTable(doc, 40, 100, rows, [260, 260]);
}

function pdfExport(data) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"a4" });

  pdfHeader(doc);
  pdfIntro(doc);
  pdfTariffMatrix(doc);
  pdfCostMatrix(doc, data);
  pdfEnergyTables(doc, data);
  pdfBatteryStats(doc, data);

  doc.save("Thuisbatterij-adviesrapport.pdf");
}
</script>

<!-- ======================= -->
<!--   HOOFDLOGICA / APP     -->
<!-- ======================= -->
<script>
const API_BASE = "https://batteryengine-server.onrender.com";
let parsedData = {};
let costChart = null;

function activateStep(n) {
  for (let i = 0; i < 5; i++) {
    const pill = document.getElementById("step-pill-" + i);
    const step = document.getElementById("step-" + i);
    if (pill) pill.classList.toggle("active", i === n);
    if (step) step.style.display = (i === n) ? "block" : "none";
  }
}

function fmtEuro(x) {
  const v = Number(x);
  if (!isFinite(v)) return "â€“";
  return "â‚¬ " + v.toFixed(2).replace(".", ",");
}

/* CSV VERWERKING */
document.getElementById("btn-parse-csv").addEventListener("click", async () => {
  const loadFile   = document.getElementById("file-load").files[0];
  const pvFile     = document.getElementById("file-pv").files[0];
  const pricesFile = document.getElementById("file-prices").files[0];
  const status     = document.getElementById("csv-status");

  if (!loadFile || !pvFile || !pricesFile) {
    status.textContent = "Alle 3 CSV-bestanden zijn vereist (load, pv, prices).";
    status.className = "status error";
    return;
  }

  status.textContent = "Verwerkenâ€¦";
  status.className = "status";

  try {
    const [loadText, pvText, pricesText] = await Promise.all([
      loadFile.text(),
      pvFile.text(),
      pricesFile.text()
    ]);

    const res = await fetch(API_BASE + "/parse_csv", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({
        load_file: loadText,
        pv_file: pvText,
        prices_file: pricesText
      })
    });

    const data = await res.json();

    if (!data || data.error) {
      status.textContent = "Fout bij verwerken van CSV (controleer formaat).";
      status.className = "status error";
      return;
    }

    parsedData = data;
    status.textContent = "CSV verwerkt âœ” (" + (data.load_kwh?.length || 0) + " records)";
    status.className = "status success";
    document.getElementById("to-step-2").disabled = false;

  } catch (err) {
    status.textContent = "Fout: " + err.message;
    status.className = "status error";
  }
});

/* NAVIGATIE */
document.getElementById("to-step-0-next").addEventListener("click", () => {
  const choice = document.querySelector('input[name="calc-type"]:checked');
  if (!choice) {
    alert("Selecteer eerst een berekeningstype.");
    return;
  }
  if (choice.value === "snelle") {
    alert("Snelle berekening komt later beschikbaar. Gebruik nu de nauwkeurige CSV-berekening.");
    return;
  }
  activateStep(1);
});

document.getElementById("to-step-2").addEventListener("click", () => activateStep(2));
document.getElementById("back-to-1").addEventListener("click", () => activateStep(1));
document.getElementById("to-step-3").addEventListener("click", () => activateStep(3));
document.getElementById("back-to-2").addEventListener("click", () => activateStep(2));

/* COMPUTE */
document.getElementById("btn-compute").addEventListener("click", async () => {
  const status = document.getElementById("compute-status");
  status.textContent = "Berekenenâ€¦";
  status.className = "status";

  if (!parsedData.load_kwh) {
    status.textContent = "CSV-data ontbreekt. Verwerk eerst de CSV-bestanden in stap 1.";
    status.className = "status error";
    return;
  }

  const body = {
    load_kwh: parsedData.load_kwh,
    pv_kwh: parsedData.pv_kwh,
    prices_dyn: parsedData.prices_dyn || [],

    p_enkel_imp: parseFloat(document.getElementById("p_enkel_imp").value || "0.29"),
    p_enkel_exp: parseFloat(document.getElementById("p_enkel_exp").value || "0.07"),

    p_dag: parseFloat(document.getElementById("p_dag").value || "0.31"),
    p_nacht: parseFloat(document.getElementById("p_nacht").value || "0.26"),
    p_exp_dn: parseFloat(document.getElementById("p_exp_dn").value || "0.07"),

    p_export_dyn: parseFloat(document.getElementById("p_export_dyn").value || "0.07"),

    E: parseFloat(document.getElementById("E").value || "0"),
    P: parseFloat(document.getElementById("P").value || "0"),
    DoD: parseFloat(document.getElementById("DoD").value || "0") / 100,
    eta_rt: parseFloat(document.getElementById("eta_rt").value || "0") / 100,

    Vastrecht: parseFloat(document.getElementById("fixed-cost").value || "0"),
    current_tariff: document.getElementById("tariff-type").value || "enkel"
  };

  try {
    const res = await fetch(API_BASE + "/compute", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });

    const data = await res.json();

    if (!data || !data.A1_per_tariff) {
      status.textContent = "Onvolledig antwoord van de server.";
      status.className = "status error";
      return;
    }

    window.computedResult = data;

    /* RESUMMARY TILES */
    document.getElementById("res-A1").textContent = fmtEuro(data.A1_current);
    document.getElementById("res-B1").textContent = fmtEuro(data.B1_future_no_batt);
    document.getElementById("res-C1").textContent = fmtEuro(data.C1_future_with_batt);

    /* TARIFF MATRIX */
    document.getElementById("A1-enkel").textContent = fmtEuro(data.A1_per_tariff.enkel);
    document.getElementById("A1-dn").textContent    = fmtEuro(data.A1_per_tariff.dag_nacht);
    document.getElementById("A1-dyn").textContent   = fmtEuro(data.A1_per_tariff.dynamisch);

    document.getElementById("B1-enkel").textContent = fmtEuro(data.S2_enkel.total_cost);
    document.getElementById("B1-dn").textContent    = fmtEuro(data.S2_dn.total_cost);
    document.getElementById("B1-dyn").textContent   = fmtEuro(data.S2_dyn.total_cost);

    document.getElementById("C1-enkel").textContent = fmtEuro(data.S3_enkel.total_cost);
    document.getElementById("C1-dn").textContent    = fmtEuro(data.S3_dn.total_cost);
    document.getElementById("C1-dyn").textContent   = fmtEuro(data.S3_dyn.total_cost);

    /* ENERGIE-INZICHTEN */
    document.getElementById("B1-imp-enkel").textContent = data.S2_enkel.import.toFixed(1);
    document.getElementById("B1-imp-dn").textContent    = data.S2_dn.import.toFixed(1);
    document.getElementById("B1-imp-dyn").textContent   = data.S2_dyn.import.toFixed(1);

    document.getElementById("B1-exp-enkel").textContent = data.S2_enkel.export.toFixed(1);
    document.getElementById("B1-exp-dn").textContent    = data.S2_dn.export.toFixed(1);
    document.getElementById("B1-exp-dyn").textContent   = data.S2_dyn.export.toFixed(1);

    document.getElementById("C1-imp-enkel").textContent = data.S3_enkel.import.toFixed(1);
    document.getElementById("C1-imp-dn").textContent    = data.S3_dn.import.toFixed(1);
    document.getElementById("C1-imp-dyn").textContent   = data.S3_dyn.import.toFixed(1);

    document.getElementById("C1-exp-enkel").textContent = data.S3_enkel.export.toFixed(1);
    document.getElementById("C1-exp-dn").textContent    = data.S3_dn.export.toFixed(1);
    document.getElementById("C1-exp-dyn").textContent   = data.S3_dyn.export.toFixed(1);

    /* CHART.js */
    const ctx = document.getElementById("chart").getContext("2d");
    if (costChart) costChart.destroy();

    costChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: ["Huidige situatie", "Zonder batterij", "Met batterij"],
        datasets: [{
          label: "Jaarlijkse kosten (â‚¬)",
          data: [
            data.A1_current,
            data.B1_future_no_batt,
            data.C1_future_with_batt
          ]
        }]
      }
    });

    status.textContent = "Berekening afgerond.";
    status.className = "status success";
    activateStep(4);
    document.getElementById("btn-download-pdf").style.display = "inline-block";

  } catch (err) {
    status.textContent = "Fout: " + err.message;
    status.className = "status error";
  }
});

/* PDF EXPORT BUTTON */
document.getElementById("btn-download-pdf").addEventListener("click", () => {
  if (!window.computedResult) {
    alert("Geen berekening beschikbaar. Voer eerst een berekening uit.");
    return;
  }
  pdfExport(window.computedResult);
});

/* DEFAULT WAARDEN */
window.addEventListener("DOMContentLoaded", () => {
  activateStep(0);

  document.getElementById("p_enkel_imp").value = "0.29";
  document.getElementById("p_enkel_exp").value = "0.07";

  document.getElementById("p_dag").value    = "0.31";
  document.getElementById("p_nacht").value  = "0.26";
  document.getElementById("p_exp_dn").value = "0.07";

  document.getElementById("p_export_dyn").value = "0.07";
});
</script>

</body>
</html>
